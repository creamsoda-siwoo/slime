<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ìŠ¬ë¼ì„ í—Œí„° (Slime Hunter)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes damage-popup {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
        }
        .animate-damage-popup {
            animation: damage-popup 1s ease-out forwards;
        }
        @keyframes damage-popup-skill {
            0% { transform: translateY(0) scale(1.2); opacity: 1; }
            100% { transform: translateY(-80px) scale(2.2); opacity: 0; }
        }
        .animate-damage-popup-skill {
            animation: damage-popup-skill 1s ease-out forwards;
        }
        @keyframes damage-popup-crit {
            0% { transform: translateY(0) scale(1.5) rotate(-5deg); opacity: 1; text-shadow: 0 0 10px #fff, 0 0 20px #fff; }
            100% { transform: translateY(-100px) scale(2.8) rotate(10deg); opacity: 0; }
        }
        .animate-damage-popup-crit {
            animation: damage-popup-crit 1s ease-out forwards;
        }


        @keyframes screen-shake {
            0% { transform: translate(0, 0) rotate(0); }
            25% { transform: translate(0.5px, -0.5px) rotate(-0.1deg); }
            50% { transform: translate(-0.5px, 0.5px) rotate(0.1deg); }
            75% { transform: translate(0.5px, 0.5px) rotate(-0.1deg); }
            100% { transform: translate(0, 0) rotate(0); }
        }
        .animate-screen-shake {
            animation: screen-shake 0.1s linear;
        }

        /* Rarity Colors */
        .text-rarity-COMMON { color: #ffffff; }
        .text-rarity-UNCOMMON { color: #1eff00; }
        .text-rarity-RARE { color: #0070dd; }
        .text-rarity-EPIC { color: #a335ee; }
        .text-rarity-LEGENDARY { color: #ff8000; }
        .text-rarity-MYTHIC { color: #2dd4bf; text-shadow: 0 0 8px #2dd4bf; }


        .border-rarity-COMMON { border-color: #6b7280; }
        .border-rarity-UNCOMMON { border-color: #16a34a; }
        .border-rarity-RARE { border-color: #2563eb; }
        .border-rarity-EPIC { border-color: #9333ea; }
        .border-rarity-LEGENDARY { border-color: #d97706; }
        .border-rarity-MYTHIC { border-color: #14b8a6; box-shadow: 0 0 10px #2dd4bf; }

        .crit-icon { color: #facc15; }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 50;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #4b5563;
            pointer-events: none;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
    <!-- Load React and ReactDOM from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX and TypeScript transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
  <body class="bg-gray-900 text-white antialiased">
    <div id="root"></div>
    <script type="text/babel" data-presets="react,typescript">
// Use global React and ReactDOM loaded from CDN, and destructure hooks for convenience.
const { useState, useEffect, useCallback, useRef, useMemo } = React;

// --- CONFIG ---
const LEVEL_EXPERIENCE_BASE = 20;
const LEVEL_EXPERIENCE_MULTIPLIER = 1.15;
const MONSTER_HP_BASE = 20;
const MONSTER_HP_MULTIPLIER = 1.16; // ë‚œì´ë„ í•˜í–¥
const MONSTER_REWARD_BASE = 5;
const MONSTER_REWARD_MULTIPLIER = 1.1;
const BOSS_LEVEL_INTERVAL = 10;
const BOSS_HP_MULTIPLIER = 4.0; // ë‚œì´ë„ í•˜í–¥
const BOSS_REWARD_MULTIPLIER = 3;
const BOSS_DROP_CHANCE_BOOST = 0.2;
const UPGRADE_COST_LEVEL_FACTOR = 0.02;

const CLICK_UPGRADE_COST_BASE = 4;
const CLICK_UPGRADE_COST_MULTIPLIER = 1.18; // ë‚œì´ë„ í•˜í–¥
const AUTO_ATTACK_UPGRADE_COST_BASE = 10;
const AUTO_ATTACK_UPGRADE_COST_MULTIPLIER = 1.25; // ë‚œì´ë„ í•˜í–¥
const CRIT_CHANCE_UPGRADE_COST_BASE = 30;
const CRIT_CHANCE_UPGRADE_COST_MULTIPLIER = 1.4; // ë‚œì´ë„ í•˜í–¥
const CRIT_CHANCE_UPGRADE_INCREASE = 1;
const CRIT_DAMAGE_UPGRADE_COST_BASE = 50;
const CRIT_DAMAGE_UPGRADE_COST_MULTIPLIER = 1.38; // ë‚œì´ë„ í•˜í–¥
const CRIT_DAMAGE_UPGRADE_INCREASE = 5; // ë²„ê·¸ ìˆ˜ì •

const GOLD_GAIN_UPGRADE_COST_BASE = 50;
const GOLD_GAIN_UPGRADE_COST_MULTIPLIER = 1.4; // ë‚œì´ë„ í•˜í–¥
const XP_GAIN_UPGRADE_COST_BASE = 75;
const XP_GAIN_UPGRADE_COST_MULTIPLIER = 1.5; // ë‚œì´ë„ í•˜í–¥

// New Upgrade Costs
const ATTACK_SPEED_UPGRADE_COST_BASE = 100;
const ATTACK_SPEED_UPGRADE_COST_MULTIPLIER = 1.35; // ë‚œì´ë„ í•˜í–¥
const HASTE_UPGRADE_COST_BASE = 250;
const HASTE_UPGRADE_COST_MULTIPLIER = 1.6; // ë‚œì´ë„ í•˜í–¥
const LUCK_UPGRADE_COST_BASE = 200;
const LUCK_UPGRADE_COST_MULTIPLIER = 1.45; // ë‚œì´ë„ í•˜í–¥

const SKILL_DAMAGE_UPGRADE_COST_BASE = 150;
const SKILL_DAMAGE_UPGRADE_COST_MULTIPLIER = 1.6; // ë‚œì´ë„ í•˜í–¥

const BOSS_DAMAGE_UPGRADE_COST_BASE = 200;
const BOSS_DAMAGE_UPGRADE_COST_MULTIPLIER = 1.5;

const LIBERATION_COST_BASE = 10000;
const LIBERATION_COST_MULTIPLIER = 100;

const BASE_SKILL_COOLDOWN = 30000; // 30 seconds
const BASE_SKILL_DAMAGE_MULTIPLIER = 5;

const EQUIPMENT_DROP_CHANCE_BASE = 0.15;
const EQUIPMENT_GACHA_COST_BASE = 100;
const EQUIPMENT_GACHA_COST_LEVEL_MULTIPLIER = 20;

const REBIRTH_LEVEL_REQUIREMENT = 30;
const REBIRTH_ALL_STAT_BONUS = 10; // All stats +10%

const SAVED_GAME_KEY = 'slimeHunterSaveData';

// --- DIFFICULTY DATA ---
const DIFFICULTIES = {
    EASY: {
        name: 'ì‰¬ì›€',
        description: 'ëŠê¸‹í•˜ê²Œ ì¦ê¸°ëŠ” ëª¨í—˜. ëª¬ìŠ¤í„°ê°€ ì•½í•˜ê³  ì„±ì¥ì´ ë¹ ë¦…ë‹ˆë‹¤.',
        multipliers: { monsterHp: 0.75, monsterReward: 1.25, upgradeCost: 0.8 }
    },
    NORMAL: {
        name: 'ë³´í†µ',
        description: 'ê· í˜• ì¡íŒ ë„ì „. í‘œì¤€ì ì¸ ê²Œì„ í”Œë ˆì´ë¥¼ ê²½í—˜í•˜ì„¸ìš”.',
        multipliers: { monsterHp: 1.0, monsterReward: 1.0, upgradeCost: 1.0 }
    },
    HARD: {
        name: 'ì–´ë ¤ì›€',
        description: 'ì§„ì •í•œ í—Œí„°ë¥¼ ìœ„í•œ ì‹œë ¨. ëª¬ìŠ¤í„°ê°€ ê°•ë ¥í•˜ì§€ë§Œ, ë³´ìƒì´ ë” í½ë‹ˆë‹¤.',
        multipliers: { monsterHp: 1.5, monsterReward: 1.2, upgradeCost: 1.2 }
    }
};

// --- JOB DATA ---
const JOBS = {
    WARRIOR: {
        name: 'ì „ì‚¬',
        description: 'ê°•ë ¥í•œ í´ë¦­ ê³µê²©ê³¼ ì§€ì†ì ì¸ ì „íˆ¬ì— íŠ¹í™”ë˜ì—ˆìŠµë‹ˆë‹¤.',
        passive: 'í´ë¦­ ë°ë¯¸ì§€ +25%, ìë™ ê³µê²© ë°ë¯¸ì§€ +10%',
        skill: { name: 'ê´‘í­í™”', description: '5ì´ˆê°„ í´ë¦­ ë°ë¯¸ì§€ 2ë°°, ê³µê²© ì†ë„ 2ë°° ì¦ê°€' },
        bonuses: { clickDamage: 0.25, autoAttackDamage: 0.10, critChance: 0, critDamage: 0, skillEffect: 0 },
        icon: (props) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
    },
    ARCHER: {
        name: 'ê¶ìˆ˜',
        description: 'ì¹˜ëª…íƒ€ë¥¼ í™œìš©í•˜ì—¬ í­ë°œì ì¸ ë°ë¯¸ì§€ë¥¼ ì…í™ë‹ˆë‹¤.',
        passive: 'í¬ë¦¬í‹°ì»¬ í™•ë¥  +10%p, í¬ë¦¬í‹°ì»¬ ë°ë¯¸ì§€ +50%p',
        skill: { name: 'í•„ì‚´ì˜ í•œ ë°œ', description: 'ë‹¤ìŒ í´ë¦­ ê³µê²©ì´ 100% í™•ë¥ ë¡œ í¬ë¦¬í‹°ì»¬ë¡œ ì ìš©ë˜ë©°, 5ë°°ì˜ ë°ë¯¸ì§€ë¥¼ ì¤ë‹ˆë‹¤.' },
        bonuses: { clickDamage: 0, autoAttackDamage: 0, critChance: 10, critDamage: 50, skillEffect: 0 },
        icon: (props) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
    },
    MAGE: {
        name: 'ë§ˆë²•ì‚¬',
        description: 'ê°•ë ¥í•œ ìŠ¤í‚¬ë¡œ ì „ì¥ì„ ì§€ë°°í•©ë‹ˆë‹¤.',
        passive: 'ìŠ¤í‚¬ ë°ë¯¸ì§€ +50%, ìŠ¤í‚¬ ì¿¨íƒ€ì„ ê°ì†Œ íš¨ê³¼ +25%',
        skill: { name: 'ë©”í…Œì˜¤', description: 'ì ì—ê²Œ ì´ ê³µê²©ë ¥(í´ë¦­+ìë™)ì˜ 25ë°°ì— í•´ë‹¹í•˜ëŠ” ë§‰ëŒ€í•œ í”¼í•´ë¥¼ ì…í™ë‹ˆë‹¤.' },
        bonuses: { clickDamage: 0, autoAttackDamage: 0, critChance: 0, critDamage: 0, skillEffect: 0.5 },
        icon: (props) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.362-3.797z" /></svg>
    }
};


// --- EQUIPMENT DATA ---
const EQUIPMENT_TYPES = {
    WEAPON: { name: 'ë¬´ê¸°', icon: (props) => <SwordIcon {...props}/> },
    ARMOR: { name: 'ë°©ì–´êµ¬', icon: (props) => <ArmorIcon {...props}/> },
    AMULET: { name: 'ì¥ì‹ êµ¬', icon: (props) => <AmuletIcon {...props}/> }
};

const RARITY_ORDER = ['COMMON', 'UNCOMMON', 'RARE', 'EPIC', 'LEGENDARY', 'MYTHIC'];
const RARITIES = {
    COMMON: { name: 'ì¼ë°˜', textClass: 'text-rarity-COMMON', borderClass: 'border-rarity-COMMON', statMultiplier: 1 },
    UNCOMMON: { name: 'ê³ ê¸‰', textClass: 'text-rarity-UNCOMMON', borderClass: 'border-rarity-UNCOMMON', statMultiplier: 1.6 },
    RARE: { name: 'í¬ê·€', textClass: 'text-rarity-RARE', borderClass: 'border-rarity-RARE', statMultiplier: 2.8 },
    EPIC: { name: 'ì˜ì›…', textClass: 'text-rarity-EPIC', borderClass: 'border-rarity-EPIC', statMultiplier: 5 },
    LEGENDARY: { name: 'ì „ì„¤', textClass: 'text-rarity-LEGENDARY', borderClass: 'border-rarity-LEGENDARY', statMultiplier: 8 },
    MYTHIC: { name: 'ì‹ í™”', textClass: 'text-rarity-MYTHIC', borderClass: 'border-rarity-MYTHIC', statMultiplier: 15 }
};
const RARITY_UPGRADE_COSTS = {
    RARE: { essence: 'RARE', cost: 10 },
    EPIC: { essence: 'EPIC', cost: 10 },
    LEGENDARY: { essence: 'LEGENDARY', cost: 10 },
};

// --- ICONS ---
const LevelIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" /> </svg> );
const XPIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 11l7-7 7 7M5 19l7-7 7 7" /> </svg> );
const CoinIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8v1m0 6v1m0-1c-1.11 0-2.08-.402-2.599-1M12 18c1.11 0 2.08-.402-2.599-1M8.999 12H8m8 0h-.001M12 21a9 9 0 110-18 9 9 0 010 18z" /> </svg> );
const SwordIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /> </svg> );
const DpsIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /> </svg> );
const CritIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1 inline-block crit-icon" fill="currentColor" viewBox="0 0 24 24" {...props}> <path d="M12 .587l3.668 7.568 8.332 1.151-6.064 5.828 1.48 8.279-7.416-3.967-7.417 3.967 1.481-8.279-6.064-5.828 8.332-1.151z" /> </svg> );
const ArmorIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /> </svg> );
const AmuletIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6.5-1.5l3.5 3.5M4 12H2m13.5 1.5L12 17l-3.5-3.5M12 8a4 4 0 100 8 4 4 0 000-8z" /> </svg> );
const GachaIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" /> <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2z" /> </svg> );
const AttackSpeedIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> );
const LuckIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> );
const OrbIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.75c-3.314 0-6 2.686-6 6s2.686 6 6 6 6-2.686 6-6-2.686-6-6-6zm0 10.5c-2.485 0-4.5-2.015-4.5-4.5S9.515 6.25 12 6.25s4.5 2.015 4.5 4.5-2.015 4.5-4.5 4.5zM12 8a1 1 0 100 2 1 1 0 000-2z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 2a10 10 0 100 20 10 10 0 000-20z" /></svg> );
const EssenceIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M12 12l10-5" /></svg> );
const BossIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 1.052A10.952 10.952 0 003.848 5.766L2 12l1.848 6.234A10.952 10.952 0 0012 22.948a10.952 10.952 0 008.152-4.714L22 12l-1.848-6.234A10.952 10.952 0 0012 1.052z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 14s1.5-2 4-2 4 2 4 2" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 9h.01M15 9h.01" /></svg> );

// Monster Icons
const GreenSlimeIcon = () => ( <svg viewBox="0 0 100 80" className="w-96 h-96 drop-shadow-lg"> <path d="M 35 25 C 40 20, 50 20, 55 25" fill="rgba(255,255,255,0.5)" stroke="none"></path> <path d="M 50 80 C 10 80, 10 40, 10 40 C 10 10, 40 10, 50 10 C 60 10, 90 10, 90 40 C 90 40, 90 80, 50 80 Z" fill="#22c55e" stroke="#166534" strokeWidth="3"></path> <circle cx="28" cy="50" r="5" fill="#fecaca"></circle> <circle cx="72" cy="50" r="5" fill="#fecaca"></circle> <circle cx="38" cy="45" r="8" fill="white"></circle> <circle cx="62" cy="45" r="8" fill="white"></circle> <circle cx="40" cy="46" r="4" fill="black"></circle> <circle cx="64" cy="46" r="4" fill="black"></circle> <circle cx="37" cy="42" r="2" fill="white"></circle> <circle cx="61" cy="42" r="2" fill="white"></circle> <path d="M 45 60 Q 50 68, 55 60" stroke="black" fill="transparent" strokeWidth="2.5" strokeLinecap="round"></path> </svg> );
const RedSlimeIcon = () => ( <svg viewBox="0 0 100 80" className="w-96 h-96 drop-shadow-lg"> <path d="M 35 25 C 40 20, 50 20, 55 25" fill="rgba(255,255,255,0.5)" stroke="none"></path> <path d="M 50 80 C 10 80, 10 40, 10 40 C 10 10, 40 10, 50 10 C 60 10, 90 10, 90 40 C 90 40, 90 80, 50 80 Z" fill="#ef4444" stroke="#991b1b" strokeWidth="3"></path> <circle cx="38" cy="45" r="7" fill="white"></circle> <circle cx="62" cy="45" r="7" fill="white"></circle> <circle cx="40" cy="47" r="3" fill="black"></circle> <circle cx="64" cy="47" r="3" fill="black"></circle> <path d="M 45 62 Q 50 55, 55 62" stroke="black" fill="transparent" strokeWidth="2.5" strokeLinecap="round"></path> </svg> );
const BlueSlimeIcon = () => ( <svg viewBox="0 0 100 80" className="w-96 h-96 drop-shadow-lg"> <path d="M 35 25 C 40 20, 50 20, 55 25" fill="rgba(255,255,255,0.5)" stroke="none"></path> <path d="M 50 80 C 10 80, 10 40, 10 40 C 10 10, 40 10, 50 10 C 60 10, 90 10, 90 40 C 90 40, 90 80, 50 80 Z" fill="#3b82f6" stroke="#1e3a8a" strokeWidth="3"></path> <path d="M 32 40 C 35 45, 41 45, 44 40" stroke="white" fill="transparent" strokeWidth="3" strokeLinecap="round"></path> <path d="M 56 40 C 59 45, 65 45, 68 40" stroke="white" fill="transparent" strokeWidth="3" strokeLinecap="round"></path> <path d="M 45 60 Q 50 65, 55 60" stroke="black" fill="transparent" strokeWidth="2.5" strokeLinecap="round"></path> </svg> );
const BatIcon = () => ( <svg viewBox="0 0 100 100" className="w-96 h-96 drop-shadow-lg"> <path d="M 50 90 C 40 80, 30 70, 20 60 Q 10 50, 20 40 C 30 30, 40 40, 50 50 C 60 40, 70 30, 80 40 Q 90 50, 80 60 C 70 70, 60 80, 50 90 Z" fill="#4b5563" stroke="#1f2937" strokeWidth="3"></path> <circle cx="50" cy="45" r="15" fill="#374151"></circle> <path d="M 40 40 L 45 35 L 50 40" fill="none" stroke="white" strokeWidth="2"></path> <path d="M 50 40 L 55 35 L 60 40" fill="none" stroke="white" strokeWidth="2"></path> <circle cx="45" cy="48" r="3" fill="#dc2626"></circle> <circle cx="55" cy="48" r="3" fill="#dc2626"></circle> </svg> );
const GoblinIcon = () => ( <svg viewBox="0 0 100 100" className="w-96 h-96 drop-shadow-lg"> <circle cx="50" cy="50" r="40" fill="#4d7c0f" stroke="#1a2e05" strokeWidth="3"></circle> <path d="M 30 30 Q 20 50, 35 60" stroke="#1a2e05" strokeWidth="3" fill="none"></path> <path d="M 70 30 Q 80 50, 65 60" stroke="#1a2e05" strokeWidth="3" fill="none"></path> <circle cx="40" cy="45" r="5" fill="yellow"></circle> <circle cx="60" cy="45" r="5" fill="yellow"></circle> <path d="M 40 70 Q 50 80, 60 70" fill="none" stroke="#1a2e05" strokeWidth="3"></path> <path d="M 45 72 L 48 78 L 52 72" fill="white"></path> <path d="M 55 72 L 58 78 L 62 72" fill="white"></path> </svg> );
const SkeletonIcon = () => ( <svg viewBox="0 0 100 100" className="w-96 h-96 drop-shadow-lg"> <path d="M 35 80 C 30 70, 30 40, 35 30 Q 50 15, 65 30 C 70 40, 70 70, 65 80 Q 50 95, 35 80 Z" fill="#e5e7eb" stroke="#9ca3af" strokeWidth="3"></path> <circle cx="45" cy="50" r="8" fill="black"></circle> <circle cx="55" cy="50" r="8" fill="black"></circle> <path d="M 50 65 L 50 75" stroke="black" strokeWidth="3"></path> <path d="M 40 80 Q 50 85, 60 80" stroke="black" strokeWidth="3" fill="none"></path> </svg> );
const GolemIcon = () => ( <svg viewBox="0 0 100 100" className="w-96 h-96 drop-shadow-lg"> <rect x="20" y="40" width="60" height="50" fill="#6b7280" stroke="#4b5563" strokeWidth="3" rx="5"></rect> <rect x="30" y="20" width="40" height="30" fill="#7f8c9b" stroke="#4b5563" strokeWidth="3" rx="5"></rect> <circle cx="45" cy="35" r="4" fill="#dc2626"></circle> <circle cx="55" cy="35" r="4" fill="#dc2626"></circle> <rect x="10" y="50" width="20" height="30" fill="#6b7280" stroke="#4b5563" strokeWidth="3" rx="5"></rect> <rect x="70" y="50" width="20" height="30" fill="#6b7280" stroke="#4b5563" strokeWidth="3" rx="5"></rect> </svg> );
const KingSlimeIcon = () => ( <svg viewBox="0 0 100 80" className="w-96 h-96 drop-shadow-lg"> <path d="M 25 20 L 30 5 L 50 15 L 70 5 L 75 20 Z" fill="#facc15" stroke="#ca8a04" strokeWidth="2" strokeLinejoin="round"></path> <circle cx="30" cy="7" r="3" fill="#ef4444"></circle> <circle cx="50" cy="17" r="3" fill="#3b82f6"></circle> <circle cx="70" cy="7" r="3" fill="#22c55e"></circle> <path d="M 35 35 C 40 30, 50 30, 55 35" fill="rgba(255,255,255,0.5)" stroke="none"></path> <path d="M 50 80 C 10 80, 10 40, 10 40 C 10 20, 40 20, 50 20 C 60 20, 90 20, 90 40 C 90 40, 90 80, 50 80 Z" fill="#22c55e" stroke="#166534" strokeWidth="3"></path> <circle cx="28" cy="55" r="5" fill="#fecaca"></circle> <circle cx="72" cy="55" r="5" fill="#fecaca"></circle> <circle cx="38" cy="50" r="8" fill="white"></circle> <circle cx="62" cy="50" r="8" fill="white"></circle> <circle cx="40" cy="51" r="4" fill="black"></circle> <circle cx="64" cy="51" r="4" fill="black"></circle> <circle cx="37" cy="47" r="2" fill="white"></circle> <circle cx="61" cy="47" r="2" fill="white"></circle> <path d="M 45 65 Q 50 73, 55 65" stroke="black" fill="transparent" strokeWidth="2.5" strokeLinecap="round"></path> </svg> );
const DragonIcon = () => ( <svg viewBox="0 0 100 100" className="w-96 h-96 drop-shadow-lg"> <path d="M 50 10 C 20 40, 20 80, 50 90 C 80 80, 80 40, 50 10" fill="#b91c1c" stroke="#4a0404" strokeWidth="3"></path> <path d="M 40 20 C 30 30, 30 40, 40 50" fill="none" stroke="#fef2f2" strokeWidth="2"></path> <path d="M 60 20 C 70 30, 70 40, 60 50" fill="none" stroke="#fef2f2" strokeWidth="2"></path> <circle cx="45" cy="35" r="5" fill="#fef08a"></circle> <circle cx="55" cy="35" r="5" fill="#fef08a"></circle> <path d="M 45 70 Q 50 80, 55 70" stroke="white" strokeWidth="2" fill="none"></path> <path d="M 20 50 C 10 60, 10 70, 20 80" fill="#991b1b" stroke="#4a0404" strokeWidth="2"></path> <path d="M 80 50 C 90 60, 90 70, 80 80" fill="#991b1b" stroke="#4a0404" strokeWidth="2"></path> </svg> );


// --- MONSTER DATA ---
const MONSTER_TYPES = [
    { name: 'ì´ˆë¡ ìŠ¬ë¼ì„', Icon: GreenSlimeIcon, minLevel: 1 },
    { name: 'ë¹¨ê°„ ìŠ¬ë¼ì„', Icon: RedSlimeIcon, minLevel: 4 },
    { name: 'ë°•ì¥', Icon: BatIcon, minLevel: 6 },
    { name: 'íŒŒë€ ìŠ¬ë¼ì„', Icon: BlueSlimeIcon, minLevel: 9 },
    { name: 'ê³ ë¸”ë¦°', Icon: GoblinIcon, minLevel: 12 },
    { name: 'í•´ê³¨', Icon: SkeletonIcon, minLevel: 15 },
];

const BOSS_TYPES = [
    { name: 'ê³¨ë ˜', Icon: GolemIcon },
    { name: 'í‚¹ ìŠ¬ë¼ì„', Icon: KingSlimeIcon },
    { name: 'ë“œë˜ê³¤', Icon: DragonIcon },
];

// --- UTILS ---
const formatNumber = (num) => {
    const n = Math.floor(num);
    if (n < 1000) return n.toString();
    if (n < 1000000) return (n / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
    if (n < 1000000000) return (n / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
    if (n < 1000000000000) return (n / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
    return (n / 1000000000000).toFixed(1).replace(/\.0$/, '') + 'T';
};

const calculateItemStats = (baseLevel, rarityKey, typeKey) => {
    const rarity = RARITIES[rarityKey];
    const stats = { clickDamage: 0, autoAttackDamage: 0, critChance: 0, critDamage: 0 };
    const statBudget = baseLevel * rarity.statMultiplier;
    switch (typeKey) {
        case 'WEAPON': stats.clickDamage = Math.ceil(statBudget * (1 + Math.random() * 0.2)); break;
        case 'ARMOR': stats.autoAttackDamage = Math.ceil(statBudget * 0.5 * (1 + Math.random() * 0.2)); break;
        case 'AMULET':
            stats.critChance = parseFloat((statBudget * 0.1 * (1 + Math.random() * 0.1)).toFixed(1));
            stats.critDamage = Math.ceil(statBudget * 2 * (1 + Math.random() * 0.1));
            break;
    }
    return stats;
}


// --- COMPONENTS ---
const PlayerStats = ({ stats, playerClass, onNameChange, abilityStats, liberationCount, rebirthCount, onJobChangeClick }) => (
    <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
        <h2 className="text-2xl font-bold mb-4 text-green-400">í”Œë ˆì´ì–´ ì •ë³´</h2>
        <div className="flex justify-around mb-3 text-center">
             {liberationCount > 0 && ( <div className="font-bold text-yellow-300 text-lg border-2 border-yellow-400 bg-gray-700 p-2 rounded w-1/2 mr-1"> í•´ë°© {liberationCount}ë‹¨ê³„ </div> )}
             {rebirthCount > 0 && ( <div className="font-bold text-purple-400 text-lg border-2 border-purple-500 bg-gray-700 p-2 rounded w-1/2 ml-1"> í™˜ìƒ {rebirthCount}íšŒì°¨ </div> )}
        </div>
        <div className="space-y-3">
             <div className="flex justify-between items-center bg-gray-700 p-2 rounded">
                <span className="font-semibold">ì´ë¦„:</span>
                <input type="text" value={stats.playerName} onChange={(e) => onNameChange(e.target.value)} className="bg-gray-600 text-right font-bold text-lg rounded px-2 w-32" />
            </div>
            {playerClass && (
                <div className="flex justify-between items-center bg-gray-700 p-2 rounded">
                    <span className="font-semibold">ì§ì—…:</span>
                    <button onClick={onJobChangeClick} className="font-bold text-lg text-amber-400 hover:text-amber-300 transition-colors" title="ì§ì—… ë³€ê²½">
                        {JOBS[playerClass].name} <span className="text-sm">ğŸ”„</span>
                    </button>
                </div>
            )}
            <div className="flex justify-between items-center bg-gray-700 p-2 rounded"> <span className="font-semibold"><LevelIcon />ë ˆë²¨:</span> <span className="font-bold text-lg">{stats.level}</span> </div>
            <div className="bg-gray-700 p-2 rounded">
                <div className="flex justify-between items-center mb-1"> <span className="font-semibold"><XPIcon />ê²½í—˜ì¹˜:</span> <span>{formatNumber(stats.xp)} / {formatNumber(stats.maxXp)}</span> </div>
                <div className="w-full bg-gray-600 rounded-full h-4"> <div className="bg-purple-500 h-4 rounded-full" style={{ width: `${(stats.xp / stats.maxXp) * 100}%` }}></div> </div>
            </div>
            <div className="flex justify-between items-center bg-gray-700 p-2 rounded"> <span className="font-semibold"><CoinIcon />ê³¨ë“œ:</span> <span className="font-bold text-lg text-yellow-400">{formatNumber(stats.coins)}</span> </div>
            <div className="flex justify-between items-center bg-gray-700 p-2 rounded"> <span className="font-semibold"><SwordIcon />í´ë¦­ ë°ë¯¸ì§€:</span> <span>{formatNumber(stats.clickDamage)}</span> </div>
            <div className="flex justify-between items-center bg-gray-700 p-2 rounded"> <span className="font-semibold"><DpsIcon />ìë™ ê³µê²© ë°ë¯¸ì§€:</span> <span>{formatNumber(stats.autoAttackDamage)}</span> </div>
            <div className="flex justify-between items-center bg-gray-700 p-2 rounded"> <span className="font-semibold"><AttackSpeedIcon />ê³µê²© ì†ë„:</span> <span>{stats.attackSpeed.toFixed(2)} / s</span> </div>
            <div className="flex justify-between items-center bg-gray-700 p-2 rounded"> <span className="font-semibold"><CritIcon />í¬ë¦¬ í™•ë¥ :</span> <span>{stats.critChance.toFixed(1)}%</span> </div>
            <div className="flex justify-between items-center bg-gray-700 p-2 rounded"> <span className="font-semibold"><CritIcon />í¬ë¦¬ ë°ë¯¸ì§€:</span> <span>{stats.critDamage}%</span> </div>
            <div className="flex justify-between items-center bg-gray-700 p-2 rounded"> <span className="font-semibold"><LuckIcon />í–‰ìš´:</span> <span>{stats.luck}</span> </div>
            <div className="flex justify-between items-center bg-gray-700 p-2 rounded text-sm"> <span className="font-semibold text-cyan-400"><CoinIcon />ê³¨ë“œ ë³´ë„ˆìŠ¤:</span> <span className="text-cyan-400">+{abilityStats.goldGainBonus.toFixed(0)}%</span> </div>
            <div className="flex justify-between items-center bg-gray-700 p-2 rounded text-sm"> <span className="font-semibold text-purple-400"><XPIcon />ê²½í—˜ì¹˜ ë³´ë„ˆìŠ¤:</span> <span className="text-purple-400">+{abilityStats.xpGainBonus.toFixed(0)}%</span> </div>
             <div className="flex justify-between items-center bg-gray-700 p-2 rounded text-sm"> <span className="font-semibold text-red-400"><BossIcon />ë³´ìŠ¤ ë°ë¯¸ì§€:</span> <span className="text-red-400">+{abilityStats.bossDamageBonus.toFixed(0)}%</span> </div>
        </div>
    </div>
);


const EquipmentTooltip = ({ item }) => {
    if (!item) return null;
    const rarityInfo = RARITIES[item.rarity];
    const typeInfo = EQUIPMENT_TYPES[item.type];

    return (
        <div className="tooltiptext">
            <p className={`font-bold text-lg ${rarityInfo.textClass}`}>{item.name} {item.level > 0 ? `+${item.level}`: ''}</p>
            <p className="text-sm text-gray-400 mb-2"> <span className={rarityInfo.textClass}>[{rarityInfo.name}]</span> <span> {typeInfo.name}</span> </p>
            <hr className="border-gray-600 my-2" />
            <div className="space-y-1 text-sm">
                {item.stats.clickDamage > 0 && <p className="flex items-center"><SwordIcon className="h-4 w-4 mr-1.5" /> <span>í´ë¦­ ë°ë¯¸ì§€ +{formatNumber(item.stats.clickDamage)}</span></p>}
                {item.stats.autoAttackDamage > 0 && <p className="flex items-center"><DpsIcon className="h-4 w-4 mr-1.5" /> <span>ìë™ ê³µê²© +{formatNumber(item.stats.autoAttackDamage)}</span></p>}
                {item.stats.critChance > 0 && <p className="flex items-center"><CritIcon className="h-4 w-4 mr-1.5" /> <span>í¬ë¦¬ í™•ë¥  +{item.stats.critChance.toFixed(1)}%</span></p>}
                {item.stats.critDamage > 0 && <p className="flex items-center"><CritIcon className="h-4 w-4 mr-1.5" /> <span>í¬ë¦¬ ë°ë¯¸ì§€ +{item.stats.critDamage}%</span></p>}
            </div>
        </div>
    );
};

const EquipmentSlot = ({ item, type }) => {
    const IconComponent = EQUIPMENT_TYPES[type].icon;
    const rarityInfo = item ? RARITIES[item.rarity] : null;

    return (
        <div className="tooltip">
             <div className={`bg-gray-700 p-2 rounded h-16 flex items-center border-2 ${item ? rarityInfo.borderClass : 'border-gray-600'}`}>
                <IconComponent className="h-8 w-8 text-gray-400 mr-2" />
                {item ? ( <div> <p className={`font-semibold ${rarityInfo.textClass}`}>{item.name} {item.level > 0 ? `+${item.level}` : ''}</p> <p className="text-xs text-gray-400">{rarityInfo.name}</p> </div> ) : ( <p className="text-gray-500">ë¹„ì–´ìˆìŒ</p> )}
            </div>
            <EquipmentTooltip item={item} />
        </div>
    );
};


const EquipmentPanel = ({ equipment }) => (
    <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
        <h2 className="text-2xl font-bold mb-4 text-green-400">ì¥ë¹„</h2>
        <div className="space-y-3">
            <EquipmentSlot item={equipment.weapon} type="WEAPON" />
            <EquipmentSlot item={equipment.armor} type="ARMOR" />
            <EquipmentSlot item={equipment.amulet} type="AMULET" />
        </div>
    </div>
);


const MonsterDisplay = ({ monster, onClick, damagePopups }) => {
    const MonsterIcon = monster.Icon;

    return (
        <div className="transition-transform duration-100">
            <h2 className={`text-3xl font-bold text-center mb-2 ${monster.isBoss ? 'text-red-400' : ''}`}> {monster.isBoss ? `[BOSS] ${monster.name}` : monster.name} (Lv.{monster.level}) </h2>
            <div className={`w-full bg-gray-700 rounded-full h-6 mb-2 border-2 ${monster.isBoss ? 'border-red-400' : 'border-gray-600'}`}>
                <div className="bg-red-500 h-full rounded-full transition-width duration-300" style={{ width: `${(monster.hp / monster.maxHp) * 100}%` }}> </div>
            </div>
            <p className="text-center font-bold text-lg mb-4"> {formatNumber(monster.hp)} / {formatNumber(monster.maxHp)} </p>
            <div className="relative cursor-pointer" onClick={onClick} style={{ userSelect: 'none' }}>
                <MonsterIcon />
                {damagePopups.map(popup => (
                    <div key={popup.id}
                         className={`absolute font-bold text-2xl pointer-events-none 
                            ${popup.type === 'skill' ? 'text-orange-400 animate-damage-popup-skill' : ''}
                            ${popup.type === 'normal' ? 'text-yellow-300 animate-damage-popup' : ''}
                            ${popup.type === 'crit' ? 'text-yellow-200 animate-damage-popup-crit' : ''}
                         `}
                         style={{ left: `${popup.x}%`, top: `${popup.y}%` }}>
                        {formatNumber(popup.damage)}
                    </div>
                ))}
            </div>
        </div>
    );
};

const UpgradePanel = ({ upgrades, playerCoins, handlers, abilityStats, equipmentGachaCost }) => (
    <div>
        <h3 className="text-lg font-semibold mb-2 text-green-300">ì „íˆ¬ ëŠ¥ë ¥</h3>
        <div className="space-y-2">
            <div className="tooltip w-full">
                <button onClick={handlers.onUpgradeClick} disabled={playerCoins < upgrades.clickUpgradeCost} className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all duration-200 ease-in-out hover:-translate-y-0.5">
                    <p>ê²€ ê°•í™” (+{upgrades.clickUpgradeLevel})</p> <p><CoinIcon /> {formatNumber(upgrades.clickUpgradeCost)}</p>
                </button>
                 <span className="tooltiptext"> <p className="font-bold">í´ë¦­ ë°ë¯¸ì§€ ì¦ê°€</p> <p className="text-sm text-gray-300">í´ë¦­ë‹¹ ê³µê²©ë ¥ì„ ë†’ì—¬ ëª¬ìŠ¤í„°ë¥¼ ë” ë¹ ë¥´ê²Œ ì²˜ì¹˜í•©ë‹ˆë‹¤.</p> </span>
            </div>
             <div className="tooltip w-full">
                <button onClick={handlers.onUpgradeAutoAttack} disabled={playerCoins < upgrades.autoAttackUpgradeCost} className="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all duration-200 ease-in-out hover:-translate-y-0.5">
                    <p>ìë™ ê³µê²© ê°•í™” (+{upgrades.autoAttackUpgradeLevel})</p> <p><CoinIcon /> {formatNumber(upgrades.autoAttackUpgradeCost)}</p>
                </button>
                <span className="tooltiptext"> <p className="font-bold">ìë™ ê³µê²© ë°ë¯¸ì§€ ì¦ê°€</p> <p className="text-sm text-gray-300">ìë™ ê³µê²©ì˜ ê¸°ë³¸ ë°ë¯¸ì§€ë¥¼ ì¦ê°€ì‹œí‚µë‹ˆë‹¤. ê³µê²© ì†ë„ì™€ ì‹œë„ˆì§€ë¥¼ ëƒ…ë‹ˆë‹¤.</p> </span>
            </div>
            <div className="tooltip w-full">
                <button onClick={handlers.onUpgradeAttackSpeed} disabled={playerCoins < upgrades.attackSpeedUpgradeCost} className="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all duration-200 ease-in-out hover:-translate-y-0.5">
                    <p>ê³µê²© ì†ë„ ì¦ê°€ (+0.05)</p> <p><CoinIcon /> {formatNumber(upgrades.attackSpeedUpgradeCost)}</p>
                </button>
                <span className="tooltiptext"> <p className="font-bold">ê³µê²© ì†ë„ ì¦ê°€</p> <p className="text-sm text-gray-300">ì´ˆë‹¹ ìë™ ê³µê²© íšŸìˆ˜ë¥¼ ëŠ˜ë ¤ DPSë¥¼ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤.</p> </span>
            </div>
            <div className="tooltip w-full">
                <button onClick={handlers.onUpgradeCritChance} disabled={playerCoins < upgrades.critChanceUpgradeCost} className="w-full bg-yellow-600 hover:bg-yellow-700 disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all duration-200 ease-in-out hover:-translate-y-0.5">
                    <p>í¬ë¦¬ í™•ë¥  (+{CRIT_CHANCE_UPGRADE_INCREASE}%)</p> <p><CoinIcon /> {formatNumber(upgrades.critChanceUpgradeCost)}</p>
                </button>
                <span className="tooltiptext"> <p className="font-bold">í¬ë¦¬í‹°ì»¬ í™•ë¥  ì¦ê°€</p> <p className="text-sm text-gray-300">ëª¨ë“  ê³µê²©ì— ì ìš©ë˜ëŠ” ê°•ë ¥í•œ ëŠ¥ë ¥ì¹˜ì…ë‹ˆë‹¤.</p> </span>
            </div>
            <div className="tooltip w-full">
                <button onClick={handlers.onUpgradeCritDamage} disabled={playerCoins < upgrades.critDamageUpgradeCost} className="w-full bg-yellow-800 hover:bg-yellow-900 disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all duration-200 ease-in-out hover:-translate-y-0.5">
                    <p>í¬ë¦¬ ë°ë¯¸ì§€ (+{CRIT_DAMAGE_UPGRADE_INCREASE}%)</p> <p><CoinIcon /> {formatNumber(upgrades.critDamageUpgradeCost)}</p>
                </button>
                 <span className="tooltiptext"> <p className="font-bold">í¬ë¦¬í‹°ì»¬ ë°ë¯¸ì§€ ì¦ê°€</p> <p className="text-sm text-gray-300">í¬ë¦¬í‹°ì»¬ ë°ë¯¸ì§€ ë°°ìœ¨ì„ ì¦ê°€ì‹œí‚µë‹ˆë‹¤.</p> </span>
            </div>
             <div className="tooltip w-full">
                <button onClick={handlers.onUpgradeBossDamage} disabled={playerCoins < upgrades.bossDamageUpgradeCost} className="w-full bg-red-800 hover:bg-red-900 disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all duration-200 ease-in-out hover:-translate-y-0.5">
                    <p>ë³´ìŠ¤ ìŠ¬ë ˆì´ì–´ (+2%)</p> <p className="text-xs">(í˜„ì¬: +{abilityStats.bossDamageBonus.toFixed(0)}%)</p> <p><CoinIcon /> {formatNumber(upgrades.bossDamageUpgradeCost)}</p>
                </button>
                 <span className="tooltiptext"> <p className="font-bold">ë³´ìŠ¤ ë°ë¯¸ì§€ ì¦ê°€</p> <p className="text-sm text-gray-300">ë³´ìŠ¤ ëª¬ìŠ¤í„°ì—ê²Œ ì£¼ëŠ” ëª¨ë“  í”¼í•´ëŸ‰ì´ ì¦ê°€í•©ë‹ˆë‹¤.</p> </span>
            </div>
        </div>

        <h3 className="text-lg font-semibold mt-4 mb-2 text-green-300">ë³´ì¡° ëŠ¥ë ¥</h3>
        <div className="space-y-2">
            <div className="tooltip w-full">
                <button onClick={handlers.onUpgradeGoldGain} disabled={playerCoins < upgrades.goldGainUpgradeCost} className="w-full bg-cyan-600 hover:bg-cyan-700 disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all duration-200 ease-in-out hover:-translate-y-0.5">
                    <p>ê³¨ë“œ ìˆ˜ê¸‰ëŸ‰ (+5%)</p> <p className="text-xs">(í˜„ì¬: +{abilityStats.goldGainBonus.toFixed(0)}%)</p> <p><CoinIcon /> {formatNumber(upgrades.goldGainUpgradeCost)}</p>
                </button>
                <span className="tooltiptext"> <p className="font-bold">ê³¨ë“œ íšë“ëŸ‰ ì¦ê°€</p> <p className="text-sm text-gray-300">ë” ë¹ ë¥¸ ì„±ì¥ì„ ìœ„í•œ í•„ìˆ˜ íˆ¬ìì…ë‹ˆë‹¤.</p> </span>
            </div>
            <div className="tooltip w-full">
                <button onClick={handlers.onUpgradeXpGain} disabled={playerCoins < upgrades.xpGainUpgradeCost} className="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all duration-200 ease-in-out hover:-translate-y-0.5">
                    <p>ê²½í—˜ì¹˜ ìˆ˜ê¸‰ëŸ‰ (+5%)</p> <p className="text-xs">(í˜„ì¬: +{abilityStats.xpGainBonus.toFixed(0)}%)</p> <p><CoinIcon /> {formatNumber(upgrades.xpGainUpgradeCost)}</p>
                </button>
                <span className="tooltiptext"> <p className="font-bold">ê²½í—˜ì¹˜ íšë“ëŸ‰ ì¦ê°€</p> <p className="text-sm text-gray-300">ë¹ ë¥¸ ë ˆë²¨ì—…ì„ ë•ìŠµë‹ˆë‹¤.</p> </span>
            </div>
            <div className="tooltip w-full">
                <button onClick={handlers.onUpgradeLuck} disabled={playerCoins < upgrades.luckUpgradeCost} className="w-full bg-pink-500 hover:bg-pink-600 disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all duration-200 ease-in-out hover:-translate-y-0.5">
                    <p>í–‰ìš´ ì¦ê°€ (+1)</p> <p className="text-xs">(í˜„ì¬: +{abilityStats.luck} í–‰ìš´)</p> <p><CoinIcon /> {formatNumber(upgrades.luckUpgradeCost)}</p>
                </button>
                <span className="tooltiptext"> <p className="font-bold">í–‰ìš´ ì¦ê°€</p> <p className="text-sm text-gray-300">ì¥ë¹„ íšë“ í™•ë¥ ê³¼ ë” ë†’ì€ ë“±ê¸‰ì˜ ì¥ë¹„ê°€ ë‚˜ì˜¬ í™•ë¥ ì„ ë†’ì—¬ì¤ë‹ˆë‹¤.</p> </span>
            </div>
        </div>

        <h3 className="text-lg font-semibold mt-4 mb-2 text-green-300">ìŠ¤í‚¬ ê°•í™”</h3>
        <div className="space-y-2">
            <div className="tooltip w-full">
                <button onClick={handlers.onUpgradeSkillDamage} disabled={playerCoins < upgrades.skillDamageUpgradeCost} className="w-full bg-orange-600 hover:bg-orange-700 disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all duration-200 ease-in-out hover:-translate-y-0.5">
                    <p>ìŠ¤í‚¬ ê³µê²©ë ¥ (+10%)</p> <p className="text-xs">(í˜„ì¬: +{abilityStats.skillDamageBonus.toFixed(0)}%)</p> <p><CoinIcon /> {formatNumber(upgrades.skillDamageUpgradeCost)}</p>
                </button>
                <span className="tooltiptext"> <p className="font-bold">ìŠ¤í‚¬ ë°ë¯¸ì§€ ê°•í™”</p> <p className="text-sm text-gray-300">ì•¡í‹°ë¸Œ ìŠ¤í‚¬ì˜ ë°ë¯¸ì§€ë‚˜ íš¨ê³¼ë¥¼ ê°•í™”í•©ë‹ˆë‹¤.</p> </span>
            </div>
            <div className="tooltip w-full">
                <button onClick={handlers.onUpgradeHaste} disabled={playerCoins < upgrades.hasteUpgradeCost} className="w-full bg-teal-600 hover:bg-teal-700 disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all duration-200 ease-in-out hover:-translate-y-0.5">
                    <p>ê°€ì† (+1%)</p> <p className="text-xs">(í˜„ì¬: ì¿¨íƒ€ì„ -{abilityStats.haste}%)</p> <p><CoinIcon /> {formatNumber(upgrades.hasteUpgradeCost)}</p>
                </button>
                <span className="tooltiptext"> <p className="font-bold">ê°€ì† (ì¿¨íƒ€ì„ ê°ì†Œ)</p> <p className="text-sm text-gray-300">ìŠ¤í‚¬ì˜ ì¬ì‚¬ìš© ëŒ€ê¸°ì‹œê°„ì„ ì¤„ì—¬ ë” ìì£¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.</p> </span>
            </div>
        </div>

        <h3 className="text-lg font-semibold mt-4 mb-2 text-green-300">íŠ¹ë³„</h3>
         <div className="space-y-2">
            <div className="tooltip w-full">
                <button onClick={handlers.onEquipmentGacha} disabled={playerCoins < equipmentGachaCost} className="w-full bg-pink-600 hover:bg-pink-700 disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all duration-200 ease-in-out hover:-translate-y-0.5">
                    <p><GachaIcon /> ì¥ë¹„ ë½‘ê¸°</p> <p><CoinIcon /> {formatNumber(equipmentGachaCost)}</p>
                </button>
                <span className="tooltiptext"> <p className="font-bold">ì¥ë¹„ ë½‘ê¸°</p> <p className="text-sm text-gray-300">ê³¨ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ë¬´ì‘ìœ„ ì¥ë¹„ë¥¼ íšë“í•©ë‹ˆë‹¤.</p> </span>
            </div>
        </div>
    </div>
);

const InventoryPanel = ({ inventory, onSelectItem }) => {
    const [filter, setFilter] = useState('ALL');

    const filteredInventory = useMemo(() => {
        if (filter === 'ALL') return inventory;
        return inventory.filter(item => item.type === filter);
    }, [inventory, filter]);

    const FilterButton = ({ type, children }) => {
        const isActive = filter === type;
        return (
            <button
                onClick={() => setFilter(type)}
                className={`flex-1 p-2 rounded-md text-sm transition-colors ${isActive ? 'bg-green-600 text-white font-bold' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
            >
                {children}
            </button>
        );
    };

    return (
        <div>
            <div className="flex justify-between items-center mb-2">
                 <h3 className="text-lg font-semibold text-green-300">ì¸ë²¤í† ë¦¬</h3>
                 <span>{filteredInventory.length} / {inventory.length}ê°œ</span>
            </div>
            <div className="flex gap-2 mb-2">
                <FilterButton type="ALL">ì „ì²´</FilterButton>
                <FilterButton type="WEAPON"><SwordIcon className="w-5 h-5 mx-auto"/></FilterButton>
                <FilterButton type="ARMOR"><ArmorIcon className="w-5 h-5 mx-auto"/></FilterButton>
                <FilterButton type="AMULET"><AmuletIcon className="w-5 h-5 mx-auto"/></FilterButton>
            </div>
            <div className="grid grid-cols-4 gap-2 h-[410px] overflow-y-auto bg-gray-900/50 p-2 rounded">
                {filteredInventory.map(item => {
                    const rarityInfo = RARITIES[item.rarity];
                    const IconComponent = EQUIPMENT_TYPES[item.type].icon;
                    return (
                        <div key={item.id} className="tooltip" onClick={() => onSelectItem(item)}>
                            <div className={`relative aspect-square flex items-center justify-center p-1 border-2 ${rarityInfo.borderClass} bg-gray-800 rounded-md cursor-pointer hover:bg-gray-700 transition-colors`}>
                                 <IconComponent className={`h-8 w-8 ${rarityInfo.textClass}`} />
                                 {item.level > 0 && <span className="absolute bottom-0 right-0 text-xs bg-gray-900 px-1 rounded-sm">+{item.level}</span>}
                            </div>
                            <EquipmentTooltip item={item} />
                        </div>
                    );
                })}
            </div>
        </div>
    );
};


const ForgePanel = ({ selectedItem, handlers, materials, playerCoins }) => {
    const [forgeTab, setForgeTab] = useState('enhance');

    if (!selectedItem) {
        return (
            <div>
                 <h3 className="text-lg font-semibold mb-2 text-green-300">ëŒ€ì¥ê°„</h3>
                 <div className="h-[450px] flex items-center justify-center text-gray-500">
                     <p>ì¸ë²¤í† ë¦¬ì—ì„œ ì•„ì´í…œì„ ì„ íƒí•˜ì„¸ìš”.</p>
                 </div>
            </div>
        );
    }
    
    const { onForge, onUpgradeRarity, onReforge } = handlers;
    const { chaosOrbs, rarityEssences } = materials;
    const rarityInfo = RARITIES[selectedItem.rarity];
    const itemLevel = selectedItem.level || 0;

    const renderStats = (item, isNextLevel = false) => {
        const stats = isNextLevel ? {
             clickDamage: Math.ceil(item.stats.clickDamage * 1.1),
             autoAttackDamage: Math.ceil(item.stats.autoAttackDamage * 1.1),
             critChance: parseFloat((item.stats.critChance * 1.05).toFixed(1)),
             critDamage: Math.ceil(item.stats.critDamage * 1.05),
        } : item.stats;
        
        return (
             <div className="space-y-1 text-sm p-2 bg-gray-900/50 rounded">
                {stats.clickDamage > 0 && <p>í´ë¦­ ë°ë¯¸ì§€ +{formatNumber(stats.clickDamage)}</p>}
                {stats.autoAttackDamage > 0 && <p>ìë™ ê³µê²© +{formatNumber(stats.autoAttackDamage)}</p>}
                {stats.critChance > 0 && <p>í¬ë¦¬ í™•ë¥  +{stats.critChance.toFixed(1)}%</p>}
                {stats.critDamage > 0 && <p>í¬ë¦¬ ë°ë¯¸ì§€ +{stats.critDamage}%</p>}
            </div>
        );
    };
    
    const renderEnhanceTab = () => {
        const upgradeCost = Math.ceil(rarityInfo.statMultiplier * 50 * Math.pow(1.5, itemLevel) * (1 + itemLevel * 0.2));
        return (
            <div className="space-y-3">
                 <div> <p className="font-semibold mb-1">í˜„ì¬ ëŠ¥ë ¥ì¹˜</p> {renderStats(selectedItem, false)} </div>
                 <div> <p className="font-semibold mb-1">ë‹¤ìŒ ë ˆë²¨ (+{itemLevel + 1})</p> {renderStats(selectedItem, true)} </div>
                <div className="text-center">
                    <p className="mb-2 flex items-center justify-center">ë¹„ìš©: <CoinIcon/> {formatNumber(upgradeCost)}</p>
                    <button onClick={() => onForge(selectedItem)} disabled={playerCoins < upgradeCost} className="w-full bg-yellow-600 hover:bg-yellow-700 disabled:bg-gray-600 text-white font-bold py-3 px-4 rounded">
                        ê°•í™”í•˜ê¸°
                    </button>
                </div>
            </div>
        );
    };

    const renderUpgradeRarityTab = () => {
        const currentRarityIndex = RARITY_ORDER.indexOf(selectedItem.rarity);
        if (currentRarityIndex === -1 || currentRarityIndex >= RARITY_ORDER.length - 1) {
            return <div className="text-center text-gray-400 py-8">ìµœê³  ë“±ê¸‰ ì•„ì´í…œì…ë‹ˆë‹¤.</div>;
        }
        const nextRarityKey = RARITY_ORDER[currentRarityIndex + 1];
        const costInfo = RARITY_UPGRADE_COSTS[selectedItem.rarity];
        if(!costInfo) return <div className="text-center text-gray-400 py-8">ì´ ë“±ê¸‰ì€ ìŠ¹ê¸‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>;

        const hasEnoughEssences = rarityEssences[costInfo.essence] >= costInfo.cost;

        return (
             <div className="space-y-3 text-center">
                 <p>í˜„ì¬ ë“±ê¸‰: <span className={rarityInfo.textClass}>{rarityInfo.name}</span></p>
                 <p className="text-2xl font-bold my-4">â–¼</p>
                 <p>ë‹¤ìŒ ë“±ê¸‰: <span className={RARITIES[nextRarityKey].textClass}>{RARITIES[nextRarityKey].name}</span></p>
                 <div className="mt-6">
                    <p className="mb-2 flex items-center justify-center">ë¹„ìš©: <EssenceIcon className={rarityInfo.textClass}/> {costInfo.cost} ({rarityEssences[costInfo.essence] || 0} ë³´ìœ )</p>
                     <button onClick={() => onUpgradeRarity(selectedItem)} disabled={!hasEnoughEssences} className="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 text-white font-bold py-3 px-4 rounded">
                        ë“±ê¸‰ ìŠ¹ê¸‰
                    </button>
                 </div>
            </div>
        );
    };

    const renderReforgeTab = () => {
        const cost = 1;
        const hasEnoughOrbs = chaosOrbs >= cost;
         return (
             <div className="space-y-3">
                 <div> <p className="font-semibold mb-1">í˜„ì¬ ëŠ¥ë ¥ì¹˜</p> {renderStats(selectedItem, false)} </div>
                 <p className="text-sm text-gray-400 text-center">ì•„ì´í…œì˜ ê¸°ë³¸ ëŠ¥ë ¥ì¹˜ë¥¼ ë¬´ì‘ìœ„ë¡œ ì¬ì„¤ì •í•©ë‹ˆë‹¤. (ë“±ê¸‰ê³¼ ì•„ì´í…œ ì¢…ë¥˜ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)</p>
                 <div className="text-center mt-4">
                    <p className="mb-2 flex items-center justify-center">ë¹„ìš©: <OrbIcon className="text-pink-400"/> {cost} ({chaosOrbs || 0} ë³´ìœ )</p>
                     <button onClick={() => onReforge(selectedItem)} disabled={!hasEnoughOrbs} className="w-full bg-pink-600 hover:bg-pink-700 disabled:bg-gray-600 text-white font-bold py-3 px-4 rounded">
                        ëŠ¥ë ¥ì¹˜ ì¬ë ¨
                    </button>
                 </div>
            </div>
        );
    }

    return (
        <div>
            <h3 className="text-lg font-semibold mb-2 text-green-300">ëŒ€ì¥ê°„</h3>
             <div className={`p-2 rounded border-2 ${rarityInfo.borderClass} bg-gray-800 mb-4`}>
                <p className={`font-bold text-lg ${rarityInfo.textClass}`}>{selectedItem.name} {itemLevel > 0 ? `+${itemLevel}` : ''}</p>
            </div>
            <div className="flex border-b border-gray-700 mb-4 text-sm">
                <button onClick={() => setForgeTab('enhance')} className={`flex-1 py-2 text-center font-semibold ${forgeTab === 'enhance' ? 'text-yellow-400 border-b-2 border-yellow-400' : 'text-gray-400'}`}>ê°•í™”</button>
                <button onClick={() => setForgeTab('upgrade')} className={`flex-1 py-2 text-center font-semibold ${forgeTab === 'upgrade' ? 'text-purple-400 border-b-2 border-purple-400' : 'text-gray-400'}`}>ìŠ¹ê¸‰</button>
                <button onClick={() => setForgeTab('reforge')} className={`flex-1 py-2 text-center font-semibold ${forgeTab === 'reforge' ? 'text-pink-400 border-b-2 border-pink-400' : 'text-gray-400'}`}>ì¬ë ¨</button>
            </div>

            {forgeTab === 'enhance' && renderEnhanceTab()}
            {forgeTab === 'upgrade' && renderUpgradeRarityTab()}
            {forgeTab === 'reforge' && renderReforgeTab()}
        </div>
    );
};


const RightPanel = ({ activeTab, setActiveTab, selectedForgeItem, onSelectForgeItem, ...props }) => {
    const forgeHandlers = {
        onForge: props.handlers.onForgeItem,
        onUpgradeRarity: props.handlers.onUpgradeRarity,
        onReforge: props.handlers.onReforgeItem,
    };
    
    const rarityEssences = props.rarityEssences;

    return (
        <div className="w-full md:w-1/4 bg-gray-800 p-4 rounded-lg shadow-lg order-3 md:order-3">
            <div className="flex border-b border-gray-700 mb-4">
                 <button onClick={() => setActiveTab('upgrade')} className={`flex-1 py-2 text-center font-semibold ${activeTab === 'upgrade' ? 'text-green-400 border-b-2 border-green-400' : 'text-gray-400'}`}>ê°•í™”</button>
                 <button onClick={() => setActiveTab('inventory')} className={`flex-1 py-2 text-center font-semibold ${activeTab === 'inventory' ? 'text-green-400 border-b-2 border-green-400' : 'text-gray-400'}`}>ì¸ë²¤í† ë¦¬</button>
                 <button onClick={() => setActiveTab('forge')} className={`flex-1 py-2 text-center font-semibold ${activeTab === 'forge' ? 'text-green-400 border-b-2 border-green-400' : 'text-gray-400'}`}>ëŒ€ì¥ê°„</button>
            </div>
            
            {activeTab === 'upgrade' && <UpgradePanel {...props}/>}
            {activeTab === 'inventory' && <InventoryPanel inventory={props.inventory} onSelectItem={props.handlers.onSelectItem} />}
            {activeTab === 'forge' && <ForgePanel selectedItem={selectedForgeItem} handlers={forgeHandlers} materials={{ chaosOrbs: props.chaosOrbs, rarityEssences: props.rarityEssences}} playerCoins={props.playerCoins} />}
        </div>
    );
};


const LiberationButton = ({ onLiberate, cost, playerCoins, count }) => (
    <div className="w-full">
        <button
            onClick={onLiberate}
            disabled={playerCoins < cost}
            className="w-full bg-gradient-to-r from-yellow-400 via-red-500 to-pink-500 hover:from-yellow-500 hover:to-pink-600 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed text-white font-bold py-4 px-4 rounded-lg transition-all shadow-lg transform hover:scale-105">
            <p className="text-xl drop-shadow-md">í•´ë°© (ë‹¨ê³„: {count})</p>
            <p className="text-lg">ëª¨ë“  ê¸°ë³¸ ëŠ¥ë ¥ì¹˜ 2ë°°!</p>
            <p><CoinIcon /> {formatNumber(cost)}</p>
        </button>
    </div>
);

const RebirthButton = ({ onRebirth, level, count }) => {
    const canRebirth = level >= REBIRTH_LEVEL_REQUIREMENT;
    return (
        <div className="w-full">
            <button
                onClick={onRebirth}
                disabled={!canRebirth}
                className="w-full bg-gradient-to-r from-purple-500 via-indigo-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed text-white font-bold py-4 px-4 rounded-lg transition-all shadow-lg transform hover:scale-105"
            >
                <p className="text-xl drop-shadow-md">í™˜ìƒ (ìš”êµ¬ ë ˆë²¨: {REBIRTH_LEVEL_REQUIREMENT})</p>
                {!canRebirth ? (
                     <p className="text-sm">í˜„ì¬ ë ˆë²¨: {level}</p>
                ) : (
                    <>
                        <p className="text-lg">ì˜êµ¬ ëª¨ë“  ëŠ¥ë ¥ì¹˜ +{REBIRTH_ALL_STAT_BONUS}%!</p>
                        <p className="text-sm">(í˜„ì¬ {count}íšŒ, ì´ +{count * REBIRTH_ALL_STAT_BONUS}%)</p>
                    </>
                )}
            </button>
        </div>
    );
};


const ActiveSkillButton = ({ skill, onClick, cooldown, maxCooldown }) => {
    const isDisabled = cooldown > 0;
    const cooldownPercentage = (cooldown / maxCooldown) * 100;

    return (
        <button
            onClick={onClick}
            disabled={isDisabled}
            className="relative w-full bg-red-700 hover:bg-red-800 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold py-4 px-4 rounded-lg transition-colors shadow-lg overflow-hidden">
            {cooldown > 0 && (
                 <div className="absolute top-0 left-0 h-full bg-black opacity-50" style={{ width: `${100 - cooldownPercentage}%` }}></div>
            )}
            <div className="relative z-10">
                <p className="text-xl">{skill.name}</p>
                {cooldown > 0 ? ( <p>{(cooldown / 1000).toFixed(1)}ì´ˆ</p> ) : ( <p>ì‚¬ìš© ê°€ëŠ¥</p> )}
            </div>
        </button>
    );
};

const GameLog = ({ log }) => (
     <div className="w-full bg-gray-800 p-4 rounded-lg shadow-lg order-4 h-40 overflow-y-auto">
        <h3 className="text-lg font-bold mb-2 text-green-400">ê²Œì„ ë¡œê·¸</h3>
        <div className="text-sm space-y-1"> {log.map((entry, index) => ( <p key={index} className="text-gray-300" dangerouslySetInnerHTML={{ __html: entry }}></p> ))} </div>
    </div>
);

const NewItemDropModal = ({ newItem, currentItem, onEquip, onStore }) => {
    if (!newItem) return null;

    const renderItemStats = (item) => {
        if (!item) return <p className="text-gray-400">ì—†ìŒ</p>;
        const rarityInfo = RARITIES[item.rarity];
        return (
            <div className={`p-4 rounded-lg border-2 ${rarityInfo.borderClass} bg-gray-800`}>
                <p className={`font-bold text-xl ${rarityInfo.textClass}`}>{item.name}</p>
                <p className={`text-sm mb-2 ${rarityInfo.textClass}`}>[{rarityInfo.name}]</p>
                <div className="space-y-1">
                    {item.stats.clickDamage > 0 && <p><SwordIcon /> í´ë¦­ ë°ë¯¸ì§€ +{formatNumber(item.stats.clickDamage)}</p>}
                    {item.stats.autoAttackDamage > 0 && <p><DpsIcon /> ìë™ ê³µê²© +{formatNumber(item.stats.autoAttackDamage)}</p>}
                    {item.stats.critChance > 0 && <p><CritIcon /> í¬ë¦¬ í™•ë¥  +{item.stats.critChance.toFixed(1)}%</p>}
                    {item.stats.critDamage > 0 && <p><CritIcon /> í¬ë¦¬ ë°ë¯¸ì§€ +{item.stats.critDamage}%</p>}
                </div>
            </div>
        );
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div className="bg-gray-900 p-6 rounded-lg shadow-2xl w-full max-w-2xl border border-gray-700">
                <h2 className="text-3xl font-bold text-center mb-4 text-green-400">ìƒˆë¡œìš´ ì•„ì´í…œ íšë“!</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div> <h3 className="text-lg font-semibold mb-2 text-center text-yellow-400">ìƒˆ ì•„ì´í…œ</h3> {renderItemStats(newItem)} </div>
                    <div> <h3 className="text-lg font-semibold mb-2 text-center text-gray-400">í˜„ì¬ ì¥ì°©</h3> {renderItemStats(currentItem)} </div>
                </div>
                <div className="flex justify-center gap-4">
                     <button onClick={onEquip} className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-lg"> ì¥ì°© </button>
                     <button onClick={onStore} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg"> ë³´ê´€ </button>
                </div>
            </div>
        </div>
    );
};

const JobSelectionModal = ({ onSelect, onClose }) => {
    return (
        <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
            <div className="bg-gray-900 p-8 rounded-lg shadow-2xl w-full max-w-4xl border border-gray-700 text-center relative">
                <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
                <h2 className="text-4xl font-bold mb-4 text-green-400">ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš”</h2>
                <p className="text-gray-400 mb-8">ì„ íƒí•œ ì§ì—…ì€ ê²Œì„ í”Œë ˆì´ì— í° ì˜í–¥ì„ ë¯¸ì¹©ë‹ˆë‹¤.</p>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {Object.keys(JOBS).map(jobKey => {
                        const job = JOBS[jobKey];
                        const Icon = job.icon;
                        return (
                            <div key={jobKey} className="bg-gray-800 p-6 rounded-lg border-2 border-gray-700 hover:border-green-500 transition-all flex flex-col">
                                <Icon className="w-12 h-12 mx-auto mb-4 text-green-400"/>
                                <h3 className="text-2xl font-bold mb-3 text-white">{job.name}</h3>
                                <p className="text-gray-300 mb-4 flex-grow">{job.description}</p>
                                <p className="text-sm text-yellow-400 mb-1"><strong>ì§€ì† íš¨ê³¼:</strong> {job.passive}</p>
                                <p className="text-sm text-orange-400 mb-6"><strong>ì•¡í‹°ë¸Œ ìŠ¤í‚¬:</strong> {job.skill.name}</p>
                                <button onClick={() => onSelect(jobKey)} className="mt-auto w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg">
                                    {job.name}(ìœ¼)ë¡œ ì„ íƒ
                                </button>
                            </div>
                        );
                    })}
                </div>
            </div>
        </div>
    );
};

const InventoryItemDetailModal = ({ item, currentEquipped, onEquip, onSalvage, onSelectForge, onClose }) => {
    if (!item) return null;

    const renderItemStats = (itemToRender, title) => {
        if (!itemToRender) return <div><h3 className="text-lg font-semibold mb-2 text-center text-gray-400">{title}</h3><div className="p-4 rounded-lg border-2 border-gray-600 bg-gray-800 flex items-center justify-center min-h-[160px]"><p className="text-gray-500">ì—†ìŒ</p></div></div>;
        const rarityInfo = RARITIES[itemToRender.rarity];
        return (
            <div>
                 <h3 className="text-lg font-semibold mb-2 text-center text-gray-400">{title}</h3>
                <div className={`p-4 rounded-lg border-2 ${rarityInfo.borderClass} bg-gray-800 min-h-[160px]`}>
                    <p className={`font-bold text-xl ${rarityInfo.textClass}`}>{itemToRender.name} {itemToRender.level > 0 ? `+${itemToRender.level}` : ''}</p>
                    <p className={`text-sm mb-2 ${rarityInfo.textClass}`}>[{rarityInfo.name}]</p>
                    <hr className="border-gray-600 my-1"/>
                    <div className="space-y-1 mt-2">
                        {itemToRender.stats.clickDamage > 0 && <p><SwordIcon /> í´ë¦­ ë°ë¯¸ì§€ +{formatNumber(itemToRender.stats.clickDamage)}</p>}
                        {itemToRender.stats.autoAttackDamage > 0 && <p><DpsIcon /> ìë™ ê³µê²© +{formatNumber(itemToRender.stats.autoAttackDamage)}</p>}
                        {itemToRender.stats.critChance > 0 && <p><CritIcon /> í¬ë¦¬ í™•ë¥  +{itemToRender.stats.critChance.toFixed(1)}%</p>}
                        {itemToRender.stats.critDamage > 0 && <p><CritIcon /> í¬ë¦¬ ë°ë¯¸ì§€ +{itemToRender.stats.critDamage}%</p>}
                    </div>
                </div>
            </div>
        );
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onClick={onClose}>
            <div className="bg-gray-900 p-6 rounded-lg shadow-2xl w-full max-w-2xl border border-gray-700 relative" onClick={e => e.stopPropagation()}>
                <button onClick={onClose} className="absolute top-2 right-3 text-gray-500 hover:text-white text-3xl font-bold">&times;</button>
                <h2 className="text-3xl font-bold text-center mb-4 text-green-400">ì•„ì´í…œ ì •ë³´</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    {renderItemStats(item, "ì„ íƒí•œ ì•„ì´í…œ")}
                    {renderItemStats(currentEquipped, "í˜„ì¬ ì¥ì°©")}
                </div>
                <div className="flex justify-center gap-4">
                    <button onClick={() => { onEquip(item); onClose(); }} className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg">ì¥ì°©</button>
                    <button onClick={() => { onSalvage(item); onClose(); }} className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg text-lg">ë¶„í•´</button>
                    <button onClick={() => { onSelectForge(item); onClose(); }} className="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg text-lg">ëŒ€ì¥ê°„</button>
                </div>
            </div>
        </div>
    );
};

const DifficultySelectionModal = ({ onSelect }) => (
    <div className="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50">
        <div className="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-4xl border border-gray-700 text-center">
            <h2 className="text-4xl font-bold mb-4 text-green-400">ë‚œì´ë„ ì„ íƒ</h2>
            <p className="text-gray-400 mb-8">ê²Œì„ì„ ì‹œì‘í•˜ê¸° ì „ì— ë‚œì´ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. ë‚œì´ë„ëŠ” ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                {Object.keys(DIFFICULTIES).map(key => {
                    const diff = DIFFICULTIES[key];
                    return (
                        <div key={key} className="bg-gray-700 p-6 rounded-lg border-2 border-gray-600 hover:border-green-500 transition-all flex flex-col">
                            <h3 className="text-2xl font-bold mb-3 text-white">{diff.name}</h3>
                            <p className="text-gray-300 mb-4 flex-grow">{diff.description}</p>
                            <button onClick={() => onSelect(key)} className="mt-auto w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg">
                                {diff.name}ìœ¼ë¡œ ì‹œì‘
                            </button>
                        </div>
                    );
                })}
            </div>
        </div>
    </div>
);


// --- DEFAULT STATE ---
const getDefaultState = () => ({
    difficulty: null,
    playerClass: null,
    playerStats: {
        playerName: 'ìš©ì‚¬',
        level: 1,
        xp: 0,
        maxXp: LEVEL_EXPERIENCE_BASE,
        coins: 0,
        clickDamage: 1,
        autoAttackDamage: 0,
        attackSpeed: 1.0,
        critChance: 0,
        critDamage: 150,
        luck: 0,
    },
    monsterStats: {
        name: MONSTER_TYPES[0].name,
        Icon: MONSTER_TYPES[0].Icon,
        level: 1,
        hp: MONSTER_HP_BASE,
        maxHp: MONSTER_HP_BASE,
        isBoss: false,
    },
    upgrades: {
        clickUpgradeCost: CLICK_UPGRADE_COST_BASE,
        clickUpgradeLevel: 1,
        autoAttackUpgradeCost: AUTO_ATTACK_UPGRADE_COST_BASE,
        autoAttackUpgradeLevel: 1,
        critChanceUpgradeCost: CRIT_CHANCE_UPGRADE_COST_BASE,
        critDamageUpgradeCost: CRIT_DAMAGE_UPGRADE_COST_BASE,
        goldGainUpgradeCost: GOLD_GAIN_UPGRADE_COST_BASE,
        xpGainUpgradeCost: XP_GAIN_UPGRADE_COST_BASE,
        skillDamageUpgradeCost: SKILL_DAMAGE_UPGRADE_COST_BASE,
        attackSpeedUpgradeCost: ATTACK_SPEED_UPGRADE_COST_BASE,
        hasteUpgradeCost: HASTE_UPGRADE_COST_BASE,
        luckUpgradeCost: LUCK_UPGRADE_COST_BASE,
        bossDamageUpgradeCost: BOSS_DAMAGE_UPGRADE_COST_BASE,
    },
    equipment: {
        weapon: null,
        armor: null,
        amulet: null,
    },
    gameLog: ["ê²Œì„ ì‹œì‘! ìŠ¬ë¼ì„ì„ ì²˜ì¹˜í•˜ì„¸ìš”."],
    abilityStats: {
        goldGainBonus: 0,
        xpGainBonus: 0,
        haste: 0, // Skill Cooldown Reduction %
        skillDamageBonus: 0,
        bossDamageBonus: 0,
    },
    liberationCount: 0,
    rebirthCount: 0,
    inventory: [],
    chaosOrbs: 0,
    rarityEssences: { RARE: 0, EPIC: 0, LEGENDARY: 0, MYTHIC: 0 },
});


// --- MAIN APP ---
const App = () => {
    // State initialization with robust saved data handling
    const [difficulty, setDifficulty] = useState(() => {
        const saved = localStorage.getItem(SAVED_GAME_KEY);
        if (!saved) return null;
        try { return JSON.parse(saved).difficulty || 'NORMAL'; } // Default old saves to NORMAL
        catch (e) { return null; }
    });
    
    const [playerClass, setPlayerClass] = useState(() => {
        const saved = localStorage.getItem(SAVED_GAME_KEY);
        if (!saved) return getDefaultState().playerClass;
        try { return JSON.parse(saved).playerClass || getDefaultState().playerClass; }
        catch (e) { return getDefaultState().playerClass; }
    });

    const [playerStats, setPlayerStats] = useState(() => {
        const saved = localStorage.getItem(SAVED_GAME_KEY);
        if (!saved) return getDefaultState().playerStats;
        try { const savedGame = JSON.parse(saved); return { ...getDefaultState().playerStats, ...savedGame.playerStats }; }
        catch (e) { return getDefaultState().playerStats; }
    });

    const [monsterStats, setMonsterStats] = useState(() => {
        const saved = localStorage.getItem(SAVED_GAME_KEY);
        if (!saved) return getDefaultState().monsterStats;
        try {
            const savedGame = JSON.parse(saved); const savedMonster = savedGame.monsterStats;
            if (savedMonster) {
                const monsterData = (savedMonster.isBoss ? BOSS_TYPES.find(b => b.name === savedMonster.name) : MONSTER_TYPES.find(m => m.name === savedMonster.name)) || MONSTER_TYPES[0];
                return { ...getDefaultState().monsterStats, ...savedMonster, Icon: monsterData.Icon };
            }
            return getDefaultState().monsterStats;
        } catch (e) { return getDefaultState().monsterStats; }
    });

    const [upgrades, setUpgrades] = useState(() => {
        const saved = localStorage.getItem(SAVED_GAME_KEY);
        if (!saved) return getDefaultState().upgrades;
        try { const savedGame = JSON.parse(saved); return { ...getDefaultState().upgrades, ...savedGame.upgrades }; }
        catch (e) { return getDefaultState().upgrades; }
    });
    
    const [abilityStats, setAbilityStats] = useState(() => {
        const saved = localStorage.getItem(SAVED_GAME_KEY);
        if (!saved) return getDefaultState().abilityStats;
        try { const savedGame = JSON.parse(saved); return { ...getDefaultState().abilityStats, ...savedGame.abilityStats }; }
        catch (e) { return getDefaultState().abilityStats; }
    });
    
    const [liberationCount, setLiberationCount] = useState(() => {
        const saved = localStorage.getItem(SAVED_GAME_KEY);
        if (!saved) return getDefaultState().liberationCount;
        try { const savedGame = JSON.parse(saved); return savedGame.liberationCount || getDefaultState().liberationCount; }
        catch (e) { return getDefaultState().liberationCount; }
    });
    
    const [rebirthCount, setRebirthCount] = useState(() => {
        const saved = localStorage.getItem(SAVED_GAME_KEY);
        if (!saved) return getDefaultState().rebirthCount;
        try { const savedGame = JSON.parse(saved); return savedGame.rebirthCount || getDefaultState().rebirthCount; }
        catch (e) { return getDefaultState().rebirthCount; }
    });

    const [equipment, setEquipment] = useState(() => {
        const saved = localStorage.getItem(SAVED_GAME_KEY);
        if (!saved) return getDefaultState().equipment;
        try { const savedGame = JSON.parse(saved); return savedGame.equipment || getDefaultState().equipment; }
        catch (e) { return getDefaultState().equipment; }
    });
    
    const [inventory, setInventory] = useState(() => {
        const saved = localStorage.getItem(SAVED_GAME_KEY);
        if (!saved) return getDefaultState().inventory;
        try { const savedGame = JSON.parse(saved); return savedGame.inventory || getDefaultState().inventory; }
        catch (e) { return getDefaultState().inventory; }
    });

    const [chaosOrbs, setChaosOrbs] = useState(() => {
        const saved = localStorage.getItem(SAVED_GAME_KEY);
        if (!saved) return getDefaultState().chaosOrbs;
        try { return JSON.parse(saved).chaosOrbs || getDefaultState().chaosOrbs; }
        catch (e) { return getDefaultState().chaosOrbs; }
    });
    
    const [rarityEssences, setRarityEssences] = useState(() => {
        const saved = localStorage.getItem(SAVED_GAME_KEY);
        if (!saved) return getDefaultState().rarityEssences;
        try { return { ...getDefaultState().rarityEssences, ...JSON.parse(saved).rarityEssences }; }
        catch (e) { return getDefaultState().rarityEssences; }
    });

    const [gameLog, setGameLog] = useState(() => {
        const saved = localStorage.getItem(SAVED_GAME_KEY);
        if (!saved) return getDefaultState().gameLog;
        try { const savedGame = JSON.parse(saved); return savedGame.gameLog || getDefaultState().gameLog; }
        catch (e) { return getDefaultState().gameLog; }
    });
    
    // UI State
    const [activeTab, setActiveTab] = useState('upgrade');
    const [selectedForgeItem, setSelectedForgeItem] = useState(null);
    const [isJobSelectionOpen, setIsJobSelectionOpen] = useState(false);
    const [selectedInventoryItem, setSelectedInventoryItem] = useState(null);

    const [activeSkillCooldown, setActiveSkillCooldown] = useState(0);
    const [damagePopups, setDamagePopups] = useState([]);
    const [newItemDrop, setNewItemDrop] = useState(null);
    const [berserkActive, setBerserkActive] = useState(false);
    const [deadlyShotActive, setDeadlyShotActive] = useState(false);
    const needsSave = useRef(false);

    const difficultyMultipliers = useMemo(() => {
        return difficulty ? DIFFICULTIES[difficulty].multipliers : DIFFICULTIES.NORMAL.multipliers;
    }, [difficulty]);

    const finalStats = useMemo(() => {
        let combined = { ...playerStats };
        Object.values(equipment).forEach(item => {
            if (!item) return;
            const itemLevel = item.level || 0;
            const multiplier = Math.pow(1.1, itemLevel);
            const critMultiplier = Math.pow(1.05, itemLevel);

            if (item.stats.clickDamage) combined.clickDamage += item.stats.clickDamage * multiplier;
            if (item.stats.autoAttackDamage) combined.autoAttackDamage += item.stats.autoAttackDamage * multiplier;
            if (item.stats.critChance) combined.critChance += item.stats.critChance * critMultiplier;
            if (item.stats.critDamage) combined.critDamage += item.stats.critDamage * critMultiplier;
        });

        if (playerClass && JOBS[playerClass]) {
            const bonuses = JOBS[playerClass].bonuses;
            combined.clickDamage *= (1 + bonuses.clickDamage);
            combined.autoAttackDamage *= (1 + bonuses.autoAttackDamage);
            combined.critChance += bonuses.critChance;
            combined.critDamage += bonuses.critDamage;
        }

        // Rebirth bonus
        const rebirthMultiplier = 1 + (rebirthCount * REBIRTH_ALL_STAT_BONUS / 100);
        combined.clickDamage *= rebirthMultiplier;
        combined.autoAttackDamage *= rebirthMultiplier;

        if (berserkActive) {
            combined.clickDamage *= 2;
            combined.attackSpeed *= 2;
        }

        return combined;
    }, [playerStats, equipment, playerClass, berserkActive, rebirthCount]);
    
    const finalAbilityStats = useMemo(() => {
        let haste = abilityStats.haste;
        let skillDamage = abilityStats.skillDamageBonus;
        if (playerClass === 'MAGE') {
            haste *= 1.25;
            skillDamage *= (1 + JOBS.MAGE.bonuses.skillEffect);
        }
        
        const rebirthBonus = rebirthCount * REBIRTH_ALL_STAT_BONUS;
        
        return {
            ...abilityStats,
            goldGainBonus: abilityStats.goldGainBonus + rebirthBonus,
            xpGainBonus: abilityStats.xpGainBonus + rebirthBonus,
            bossDamageBonus: abilityStats.bossDamageBonus + rebirthBonus,
            haste,
            skillDamageBonus: skillDamage,
            activeSkillCooldown: BASE_SKILL_COOLDOWN * (1 - haste / 100),
        }
    }, [abilityStats, playerClass, rebirthCount]);

    const saveGame = useCallback(() => {
        try {
            const serializableMonsterStats = { ...monsterStats, Icon: undefined };
            const gameStateToSave = {
                difficulty, playerClass, playerStats, monsterStats: serializableMonsterStats,
                upgrades, equipment, gameLog, abilityStats, liberationCount, rebirthCount,
                inventory, chaosOrbs, rarityEssences
            };
            localStorage.setItem(SAVED_GAME_KEY, JSON.stringify(gameStateToSave));
            needsSave.current = false;
        } catch (error) { console.error("Could not save game state", error); }
    }, [difficulty, playerClass, playerStats, monsterStats, upgrades, equipment, gameLog, abilityStats, liberationCount, rebirthCount, inventory, chaosOrbs, rarityEssences]);

    useEffect(() => { if (needsSave.current) { saveGame(); } });

    const handleSelectDifficulty = (selectedDiff) => {
        const multipliers = DIFFICULTIES[selectedDiff].multipliers;
        const initialUpgrades = { ...getDefaultState().upgrades };
        for (const key in initialUpgrades) {
            if (key.endsWith('Cost')) {
                initialUpgrades[key] = Math.floor(initialUpgrades[key] * multipliers.upgradeCost);
            }
        }
        setUpgrades(initialUpgrades);
        setDifficulty(selectedDiff);
        needsSave.current = true;
    };
    
    const handleJobSelect = (jobKey) => {
        if (playerClass) {
            addLog(`<strong class="text-amber-400">ì§ì—…ì„ ${JOBS[jobKey].name}(ìœ¼)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤!</strong>`);
        } else {
            addLog(`<strong class="text-amber-400">ë‹¹ì‹ ì€ ì´ì œ ${JOBS[jobKey].name}ì…ë‹ˆë‹¤!</strong>`);
        }
        setPlayerClass(jobKey);
        setIsJobSelectionOpen(false);
        needsSave.current = true;
    };

    const addLog = useCallback((message) => { setGameLog(prevLog => [message, ...prevLog.slice(0, 19)]); }, []);

    const generateRandomItem = useCallback((monsterLevel) => {
        const luckFactor = 1 + (finalStats.luck / 200); // 200 luck = 2x chance for higher rarity
        const rarityRoll = Math.random() / luckFactor;
        let rarityKey = 'COMMON';
        if (rarityRoll < 0.005) rarityKey = 'MYTHIC';
        else if (rarityRoll < 0.02) rarityKey = 'LEGENDARY';
        else if (rarityRoll < 0.10) rarityKey = 'EPIC';
        else if (rarityRoll < 0.30) rarityKey = 'RARE';
        else if (rarityRoll < 0.60) rarityKey = 'UNCOMMON';
    
        const typeKeys = Object.keys(EQUIPMENT_TYPES);
        const typeKey = typeKeys[Math.floor(Math.random() * typeKeys.length)];
    
        const rarity = RARITIES[rarityKey];
        const item = {
            id: Date.now() + Math.random(), type: typeKey, rarity: rarityKey, name: `${rarity.name} ${EQUIPMENT_TYPES[typeKey].name}`,
            level: 0,
            baseLevel: monsterLevel,
            stats: {}
        };
        item.stats = calculateItemStats(item.baseLevel, item.rarity, item.type);
        return item;
    }, [finalStats.luck]);

    const handleMonsterDefeat = useCallback(() => {
        const isBossDefeated = monsterStats.isBoss;
        const currentMonsterLevel = monsterStats.level;
        const rewardMultiplier = (isBossDefeated ? BOSS_REWARD_MULTIPLIER : 1) * difficultyMultipliers.monsterReward;
        const xpGained = Math.ceil(currentMonsterLevel * 2.5 * rewardMultiplier * (1 + finalAbilityStats.xpGainBonus / 100));
        const coinsGained = Math.ceil(MONSTER_REWARD_BASE * Math.pow(MONSTER_REWARD_MULTIPLIER, currentMonsterLevel - 1) * rewardMultiplier * (1 + finalAbilityStats.goldGainBonus / 100));
        
        addLog(`${isBossDefeated ? `<strong>[BOSS]</strong> ` : ''}${monsterStats.name}(Lv.${currentMonsterLevel}) ì²˜ì¹˜! +${formatNumber(coinsGained)} ê³¨ë“œ, +${formatNumber(xpGained)} ê²½í—˜ì¹˜.`);

        const dropChance = EQUIPMENT_DROP_CHANCE_BASE + (currentMonsterLevel * 0.005) + (isBossDefeated ? BOSS_DROP_CHANCE_BOOST : 0) + (finalStats.luck / 100);
        if (Math.random() < dropChance && !newItemDrop) {
            const droppedItem = generateRandomItem(currentMonsterLevel);
            const rarityInfo = RARITIES[droppedItem.rarity];
            addLog(`<span class="${rarityInfo.textClass}">[${rarityInfo.name}] ${droppedItem.name}</span> íšë“!`);
            setNewItemDrop(droppedItem);
        }

        setPlayerStats(prev => {
            let newXp = prev.xp + xpGained; let newLevel = prev.level; let newMaxXp = prev.maxXp;
            let newClickDamage = prev.clickDamage; let newAutoAttackDamage = prev.autoAttackDamage;

            while (newXp >= newMaxXp) {
                newXp -= newMaxXp; newLevel += 1;
                newMaxXp = Math.floor(LEVEL_EXPERIENCE_BASE * Math.pow(LEVEL_EXPERIENCE_MULTIPLIER, newLevel - 1));
                addLog(`ë ˆë²¨ì—…! ${newLevel}ë ˆë²¨ ë‹¬ì„±!`);
                newClickDamage *= 1.01; newAutoAttackDamage *= 1.01;
                addLog(`<span class="text-yellow-300">ë ˆë²¨ì—… ë³´ë„ˆìŠ¤! ê¸°ë³¸ ê³µê²©ë ¥ì´ 1% ì¦ê°€í–ˆìŠµë‹ˆë‹¤!</span>`);
            }
            return { ...prev, level: newLevel, xp: newXp, maxXp: newMaxXp, coins: prev.coins + coinsGained, clickDamage: newClickDamage, autoAttackDamage: newAutoAttackDamage };
        });

        const newMonsterLevel = currentMonsterLevel + 1;
        let nextMonster;
        if (newMonsterLevel > 0 && newMonsterLevel % BOSS_LEVEL_INTERVAL === 0) {
            const bossIndex = Math.floor((newMonsterLevel / BOSS_LEVEL_INTERVAL - 1)) % BOSS_TYPES.length;
            const bossData = BOSS_TYPES[bossIndex];
            const newMonsterHp = Math.floor(MONSTER_HP_BASE * Math.pow(MONSTER_HP_MULTIPLIER, newMonsterLevel - 1) * BOSS_HP_MULTIPLIER * difficultyMultipliers.monsterHp);
            nextMonster = { name: bossData.name, Icon: bossData.Icon, level: newMonsterLevel, hp: newMonsterHp, maxHp: newMonsterHp, isBoss: true };
        } else {
            const availableMonsters = MONSTER_TYPES.filter(m => newMonsterLevel >= m.minLevel);
            const monsterData = availableMonsters.length > 0 ? availableMonsters[Math.floor(Math.random() * availableMonsters.length)] : MONSTER_TYPES[0];
            const newMonsterHp = Math.floor(MONSTER_HP_BASE * Math.pow(MONSTER_HP_MULTIPLIER, newMonsterLevel - 1) * difficultyMultipliers.monsterHp);
            nextMonster = { name: monsterData.name, Icon: monsterData.Icon, level: newMonsterLevel, hp: newMonsterHp, maxHp: newMonsterHp, isBoss: false };
        }
        setMonsterStats(nextMonster);
        needsSave.current = true;
    }, [monsterStats, addLog, generateRandomItem, newItemDrop, finalAbilityStats, finalStats.luck, difficultyMultipliers]);
    
    useEffect(() => {
        if (finalStats.autoAttackDamage <= 0) return;
        const interval = setInterval(() => {
            if (newItemDrop || isJobSelectionOpen || selectedInventoryItem || !difficulty) return;
            const isCrit = Math.random() * 100 < finalStats.critChance;
            const critMultiplier = isCrit ? finalStats.critDamage / 100 : 1;
            const bossMultiplier = monsterStats.isBoss ? (1 + finalAbilityStats.bossDamageBonus / 100) : 1;
            const damageDealt = Math.floor(finalStats.autoAttackDamage * critMultiplier * bossMultiplier);

            setMonsterStats(prev => {
                const newHp = prev.hp - damageDealt;
                if (newHp <= 0) { handleMonsterDefeat(); return { ...prev, hp: 0 }; }
                return { ...prev, hp: newHp };
            });
        }, 1000 / finalStats.attackSpeed);
        return () => clearInterval(interval);
    }, [finalStats.autoAttackDamage, finalStats.attackSpeed, finalStats.critChance, finalStats.critDamage, handleMonsterDefeat, newItemDrop, isJobSelectionOpen, selectedInventoryItem, monsterStats.isBoss, finalAbilityStats.bossDamageBonus, difficulty]);
    
    useEffect(() => {
        if (activeSkillCooldown > 0) {
            const timer = setTimeout(() => { setActiveSkillCooldown(prev => Math.max(0, prev - 100)); }, 100);
            return () => clearTimeout(timer);
        }
    }, [activeSkillCooldown]);
    
    const createDamagePopup = (damage, type = 'normal') => {
        const newPopup = { id: Date.now() + Math.random(), damage, x: 40 + Math.random() * 20, y: 40 + Math.random() * 20, type };
        setDamagePopups(prev => [...prev, newPopup]);
        setTimeout(() => { setDamagePopups(prev => prev.filter(p => p.id !== newPopup.id)); }, 1000);
    };

    const handleMonsterClick = () => {
        if (monsterStats.hp <= 0 || newItemDrop || isJobSelectionOpen || selectedInventoryItem) return;
        
        const bossMultiplier = monsterStats.isBoss ? (1 + finalAbilityStats.bossDamageBonus / 100) : 1;
        
        if (deadlyShotActive) {
            const skillMultiplier = 1 + (finalAbilityStats.skillDamageBonus / 100);
            const damageDealt = Math.floor(finalStats.clickDamage * 5 * skillMultiplier * bossMultiplier);
            createDamagePopup(damageDealt, 'crit');
            addLog(`í•„ì‚´ì˜ í•œ ë°œ! ${formatNumber(damageDealt)}ì˜ í”¼í•´! (í¬ë¦¬í‹°ì»¬!)`);
            setDeadlyShotActive(false); // Consume the buff
            
            setMonsterStats(prev => {
                const newHp = prev.hp - damageDealt;
                if (newHp <= 0) { handleMonsterDefeat(); return { ...prev, hp: 0 }; }
                return { ...prev, hp: newHp };
            });
            return; // Don't perform a normal click
        }

        const isCrit = Math.random() * 100 < finalStats.critChance;
        const critMultiplier = isCrit ? finalStats.critDamage / 100 : 1;
        const damageDealt = Math.floor(finalStats.clickDamage * critMultiplier * bossMultiplier);
        createDamagePopup(damageDealt, isCrit ? 'crit' : 'normal');
        setMonsterStats(prev => {
            const newHp = prev.hp - damageDealt;
            if (newHp <= 0) { handleMonsterDefeat(); return { ...prev, hp: 0 }; }
            return { ...prev, hp: newHp };
        });
    };
    
    // Upgrade Handlers
    const handleUpgrade = (cost, costMultiplier, onUpgrade) => {
        if (playerStats.coins >= cost) {
            setPlayerStats(prev => ({ ...prev, coins: prev.coins - cost }));
            onUpgrade();
            needsSave.current = true;
        }
    }
    const handleUpgradeClick = () => handleUpgrade(upgrades.clickUpgradeCost, CLICK_UPGRADE_COST_MULTIPLIER, () => {
        setPlayerStats(prev => ({ ...prev, clickDamage: prev.clickDamage + upgrades.clickUpgradeLevel }));
        setUpgrades(prev => ({ ...prev, clickUpgradeCost: Math.floor(prev.clickUpgradeCost * CLICK_UPGRADE_COST_MULTIPLIER * (1 + playerStats.level * UPGRADE_COST_LEVEL_FACTOR)), clickUpgradeLevel: prev.clickUpgradeLevel + 1 }));
    });
    const handleUpgradeAutoAttack = () => handleUpgrade(upgrades.autoAttackUpgradeCost, AUTO_ATTACK_UPGRADE_COST_MULTIPLIER, () => {
        setPlayerStats(prev => ({ ...prev, autoAttackDamage: prev.autoAttackDamage + upgrades.autoAttackUpgradeLevel }));
        setUpgrades(prev => ({ ...prev, autoAttackUpgradeCost: Math.floor(prev.autoAttackUpgradeCost * AUTO_ATTACK_UPGRADE_COST_MULTIPLIER * (1 + playerStats.level * UPGRADE_COST_LEVEL_FACTOR)), autoAttackUpgradeLevel: prev.autoAttackUpgradeLevel + 1 }));
    });
    const handleUpgradeAttackSpeed = () => handleUpgrade(upgrades.attackSpeedUpgradeCost, ATTACK_SPEED_UPGRADE_COST_MULTIPLIER, () => {
        setPlayerStats(prev => ({ ...prev, attackSpeed: prev.attackSpeed + 0.05 }));
        setUpgrades(prev => ({ ...prev, attackSpeedUpgradeCost: Math.floor(prev.attackSpeedUpgradeCost * ATTACK_SPEED_UPGRADE_COST_MULTIPLIER * (1 + playerStats.level * UPGRADE_COST_LEVEL_FACTOR))}));
    });
    const handleUpgradeCritChance = () => handleUpgrade(upgrades.critChanceUpgradeCost, CRIT_CHANCE_UPGRADE_COST_MULTIPLIER, () => {
        setPlayerStats(prev => ({ ...prev, critChance: prev.critChance + CRIT_CHANCE_UPGRADE_INCREASE }));
        setUpgrades(prev => ({ ...prev, critChanceUpgradeCost: Math.floor(prev.critChanceUpgradeCost * CRIT_CHANCE_UPGRADE_COST_MULTIPLIER * (1 + playerStats.level * UPGRADE_COST_LEVEL_FACTOR)) }));
    });
    const handleUpgradeCritDamage = () => handleUpgrade(upgrades.critDamageUpgradeCost, CRIT_DAMAGE_UPGRADE_COST_MULTIPLIER, () => {
        setPlayerStats(prev => ({ ...prev, critDamage: prev.critDamage + CRIT_DAMAGE_UPGRADE_INCREASE }));
        setUpgrades(prev => ({ ...prev, critDamageUpgradeCost: Math.floor(prev.critDamageUpgradeCost * CRIT_DAMAGE_UPGRADE_COST_MULTIPLIER * (1 + playerStats.level * UPGRADE_COST_LEVEL_FACTOR)) }));
    });
    const handleUpgradeGoldGain = () => handleUpgrade(upgrades.goldGainUpgradeCost, GOLD_GAIN_UPGRADE_COST_MULTIPLIER, () => {
        setAbilityStats(prev => ({ ...prev, goldGainBonus: prev.goldGainBonus + 5 }));
        setUpgrades(prev => ({ ...prev, goldGainUpgradeCost: Math.floor(prev.goldGainUpgradeCost * GOLD_GAIN_UPGRADE_COST_MULTIPLIER * (1 + playerStats.level * UPGRADE_COST_LEVEL_FACTOR)) }));
    });
    const handleUpgradeXpGain = () => handleUpgrade(upgrades.xpGainUpgradeCost, XP_GAIN_UPGRADE_COST_MULTIPLIER, () => {
        setAbilityStats(prev => ({ ...prev, xpGainBonus: prev.xpGainBonus + 5 }));
        setUpgrades(prev => ({ ...prev, xpGainUpgradeCost: Math.floor(prev.xpGainUpgradeCost * XP_GAIN_UPGRADE_COST_MULTIPLIER * (1 + playerStats.level * UPGRADE_COST_LEVEL_FACTOR)) }));
    });
    const handleUpgradeSkillDamage = () => handleUpgrade(upgrades.skillDamageUpgradeCost, SKILL_DAMAGE_UPGRADE_COST_MULTIPLIER, () => {
        setAbilityStats(prev => ({ ...prev, skillDamageBonus: prev.skillDamageBonus + 10 }));
        setUpgrades(prev => ({ ...prev, skillDamageUpgradeCost: Math.floor(prev.skillDamageUpgradeCost * SKILL_DAMAGE_UPGRADE_COST_MULTIPLIER * (1 + playerStats.level * UPGRADE_COST_LEVEL_FACTOR)) }));
    });
    const handleUpgradeHaste = () => handleUpgrade(upgrades.hasteUpgradeCost, HASTE_UPGRADE_COST_MULTIPLIER, () => {
        setAbilityStats(prev => ({ ...prev, haste: prev.haste + 1 }));
        setUpgrades(prev => ({ ...prev, hasteUpgradeCost: Math.floor(prev.hasteUpgradeCost * HASTE_UPGRADE_COST_MULTIPLIER * (1 + playerStats.level * UPGRADE_COST_LEVEL_FACTOR)) }));
    });
    const handleUpgradeLuck = () => handleUpgrade(upgrades.luckUpgradeCost, LUCK_UPGRADE_COST_MULTIPLIER, () => {
        setPlayerStats(prev => ({ ...prev, luck: prev.luck + 1 }));
        setUpgrades(prev => ({ ...prev, luckUpgradeCost: Math.floor(prev.luckUpgradeCost * LUCK_UPGRADE_COST_MULTIPLIER * (1 + playerStats.level * UPGRADE_COST_LEVEL_FACTOR)) }));
    });
    const handleUpgradeBossDamage = () => handleUpgrade(upgrades.bossDamageUpgradeCost, BOSS_DAMAGE_UPGRADE_COST_MULTIPLIER, () => {
        setAbilityStats(prev => ({ ...prev, bossDamageBonus: prev.bossDamageBonus + 2 }));
        setUpgrades(prev => ({ ...prev, bossDamageUpgradeCost: Math.floor(prev.bossDamageUpgradeCost * BOSS_DAMAGE_UPGRADE_COST_MULTIPLIER * (1 + playerStats.level * UPGRADE_COST_LEVEL_FACTOR)) }));
    });

    const handleActiveSkill = () => {
        if (activeSkillCooldown > 0 || newItemDrop || !playerClass) return;
        
        let damageDealt = 0;
        let logMessage = '';
        const skillMultiplier = 1 + (finalAbilityStats.skillDamageBonus / 100);
        const bossMultiplier = monsterStats.isBoss ? (1 + finalAbilityStats.bossDamageBonus / 100) : 1;

        switch(playerClass) {
            case 'WARRIOR':
                setBerserkActive(true);
                setTimeout(() => setBerserkActive(false), 5000);
                logMessage = `ê´‘í­í™” ë°œë™! 5ì´ˆê°„ ê³µê²©ì´ ê°•í™”ë©ë‹ˆë‹¤!`;
                break;
            case 'ARCHER':
                setDeadlyShotActive(true);
                logMessage = `í•„ì‚´ì˜ í•œ ë°œ ì¤€ë¹„ ì™„ë£Œ! ë‹¤ìŒ ê³µê²©ì´ ê°•í™”ë©ë‹ˆë‹¤!`;
                break;
            case 'MAGE':
                damageDealt = Math.floor((finalStats.autoAttackDamage + finalStats.clickDamage) * 25 * skillMultiplier * bossMultiplier);
                createDamagePopup(damageDealt, 'skill');
                logMessage = `ë©”í…Œì˜¤! ${formatNumber(damageDealt)}ì˜ í”¼í•´!`;
                break;
        }

        addLog(logMessage);
        setActiveSkillCooldown(finalAbilityStats.activeSkillCooldown);

        if(damageDealt > 0) {
            setMonsterStats(prev => {
                const newHp = prev.hp - damageDealt;
                if (newHp <= 0) { handleMonsterDefeat(); return { ...prev, hp: 0 }; }
                return { ...prev, hp: newHp };
            });
        }
        needsSave.current = true;
    };
    
    const handleLiberation = () => {
        const cost = liberationCost;
        if (playerStats.coins >= cost) {
            setPlayerStats(prev => ({
                ...prev, coins: prev.coins - cost, clickDamage: prev.clickDamage * 2,
                autoAttackDamage: prev.autoAttackDamage * 2, critChance: prev.critChance * 2, critDamage: prev.critDamage * 2,
            }));
            const newLiberationCount = liberationCount + 1;
            setLiberationCount(newLiberationCount);
            addLog(`<strong class="text-yellow-300">í•´ë°©! ëª¨ë“  ê¸°ë³¸ ëŠ¥ë ¥ì¹˜ê°€ 2ë°°ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤! (ë‹¨ê³„: ${newLiberationCount})</strong>`);
            needsSave.current = true;
        }
    }
    
    const handleRebirth = useCallback(() => {
        if (playerStats.level < REBIRTH_LEVEL_REQUIREMENT) return;
        if (window.confirm(`í™˜ìƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n- ë ˆë²¨, ê³¨ë“œ, ì—…ê·¸ë ˆì´ë“œê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.\n- ì¥ë¹„ì™€ ì¸ë²¤í† ë¦¬ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.\n- ì˜êµ¬ì ìœ¼ë¡œ ëª¨ë“  ëŠ¥ë ¥ì¹˜ê°€ ${REBIRTH_ALL_STAT_BONUS}% ì¦ê°€í•©ë‹ˆë‹¤.\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
            const newRebirthCount = rebirthCount + 1;
            setRebirthCount(newRebirthCount);
            
            const defaultPlayerState = getDefaultState().playerStats;
            setPlayerStats(prev => ({
                ...defaultPlayerState,
                playerName: prev.playerName, // Keep player name
            }));
            
            const multipliers = difficulty ? DIFFICULTIES[difficulty].multipliers : DIFFICULTIES.NORMAL.multipliers;
            const initialUpgrades = { ...getDefaultState().upgrades };
            for (const key in initialUpgrades) {
                if (key.endsWith('Cost')) {
                    initialUpgrades[key] = Math.floor(initialUpgrades[key] * multipliers.upgradeCost);
                }
            }
            setUpgrades(initialUpgrades);

            setAbilityStats(getDefaultState().abilityStats);
            setMonsterStats(getDefaultState().monsterStats);
            setLiberationCount(0);
            
            addLog(`<strong class="text-purple-400">í™˜ìƒ ${newRebirthCount}íšŒì°¨! ìƒˆë¡œìš´ ì—¬ì •ì´ ì‹œì‘ë©ë‹ˆë‹¤. (ì˜êµ¬ ë³´ë„ˆìŠ¤: +${newRebirthCount * REBIRTH_ALL_STAT_BONUS}%)</strong>`);
            needsSave.current = true;
        }
    }, [playerStats.level, rebirthCount, addLog, difficulty]);

    const handlePlayerNameChange = (newName) => { setPlayerStats(prev => ({...prev, playerName: newName})); needsSave.current = true; };

    const handleEquipmentGacha = () => {
        if (playerStats.coins >= equipmentGachaCost && !newItemDrop) {
            setPlayerStats(prev => ({ ...prev, coins: prev.coins - equipmentGachaCost }));
            const droppedItem = generateRandomItem(playerStats.level);
            const rarityInfo = RARITIES[droppedItem.rarity];
            addLog(`ì¥ë¹„ ë½‘ê¸°! <span class="${rarityInfo.textClass}">[${rarityInfo.name}] ${droppedItem.name}</span> íšë“!`);
            setNewItemDrop(droppedItem);
            needsSave.current = true;
        }
    };
    
    const handleEquipItem = useCallback((itemToEquip) => {
        if (!itemToEquip) return;
        const itemTypeKey = itemToEquip.type.toLowerCase();
        const currentEquippedItem = equipment[itemTypeKey];
        
        let newInventory = inventory.filter(i => i.id !== itemToEquip.id);
        if (currentEquippedItem) {
            newInventory.push(currentEquippedItem);
        }
        
        setInventory(newInventory);
        setEquipment(prev => ({ ...prev, [itemTypeKey]: itemToEquip }));
        
        if (newItemDrop && newItemDrop.id === itemToEquip.id) {
            setNewItemDrop(null);
        }
        needsSave.current = true;
    }, [equipment, inventory, newItemDrop]);
    
    const handleStoreNewItem = () => {
        if (!newItemDrop) return;
        setInventory(prev => [...prev, newItemDrop]);
        addLog(`[${newItemDrop.name}] ì•„ì´í…œì„ ì¸ë²¤í† ë¦¬ì— ë³´ê´€í–ˆìŠµë‹ˆë‹¤.`);
        setNewItemDrop(null);
        needsSave.current = true;
    };
    
    const handleSalvageItem = useCallback((itemToSalvage) => {
        if (!itemToSalvage || !window.confirm(`[${itemToSalvage.name}] ì•„ì´í…œì„ ì •ë§ë¡œ ë¶„í•´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        const rarityKey = itemToSalvage.rarity;
        let orbsGained = 0;
        let essencesGained = { type: null, amount: 0 };
        let logParts = [];
        
        if(RARITY_ORDER.indexOf(rarityKey) >= RARITY_ORDER.indexOf('RARE')) {
            setRarityEssences(prev => ({...prev, [rarityKey]: prev[rarityKey] + 1}));
            essencesGained = { type: rarityKey, amount: 1 };
            logParts.push(`<span class="${RARITIES[rarityKey].textClass}">${RARITIES[rarityKey].name} ì •ìˆ˜ +1</span>`);
        }
        if(rarityKey === 'EPIC') { orbsGained = 1; }
        if(rarityKey === 'LEGENDARY') { orbsGained = 2; }
        if(rarityKey === 'MYTHIC') { orbsGained = 5; }

        if(orbsGained > 0) {
             setChaosOrbs(prev => prev + orbsGained);
             logParts.push(`<span class="text-pink-400">ë³€í™”ì˜ ë³´ì£¼ +${orbsGained}</span>`);
        }
        
        setInventory(prev => prev.filter(i => i.id !== itemToSalvage.id));
        if (selectedForgeItem && selectedForgeItem.id === itemToSalvage.id) {
            setSelectedForgeItem(null);
        }
        
        if (logParts.length > 0) {
            addLog(`[${itemToSalvage.name}] ë¶„í•´ ì™„ë£Œ! ${logParts.join(', ')}.`);
        } else {
            addLog(`[${itemToSalvage.name}] ë¶„í•´ ì™„ë£Œ!`);
        }
        needsSave.current = true;
    }, [selectedForgeItem, addLog]);

    const updateItemInState = (updatedItem) => {
        const itemTypeKey = updatedItem.type.toLowerCase();
        if (equipment[itemTypeKey] && equipment[itemTypeKey].id === updatedItem.id) {
             setEquipment(prev => ({...prev, [itemTypeKey]: updatedItem}));
        } else {
            setInventory(prev => prev.map(i => i.id === updatedItem.id ? updatedItem : i));
        }
    };

    const handleForgeItem = useCallback((itemToForge) => {
        if (!itemToForge) return;
        const rarityInfo = RARITIES[itemToForge.rarity];
        const itemLevel = itemToForge.level || 0;
        const cost = Math.ceil(rarityInfo.statMultiplier * 50 * Math.pow(1.5, itemLevel) * (1 + itemLevel * 0.2));

        if (playerStats.coins < cost) {
            addLog(`<strong class="text-red-400">ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!</strong>`);
            return;
        }
        setPlayerStats(prev => ({...prev, coins: prev.coins - cost}));

        const updatedItem = { ...itemToForge, level: itemLevel + 1 };
        updateItemInState(updatedItem);
        setSelectedForgeItem(updatedItem);
        
        addLog(`[${itemToForge.name}] ê°•í™” ì„±ê³µ! <strong class="${rarityInfo.textClass}">(+${updatedItem.level})</strong> -${formatNumber(cost)} ê³¨ë“œ`);
        needsSave.current = true;
    }, [playerStats.coins, equipment, addLog]);
    
    const handleUpgradeRarity = useCallback((item) => {
        const currentRarityIndex = RARITY_ORDER.indexOf(item.rarity);
        if(currentRarityIndex >= RARITY_ORDER.length - 1) return;
        const costInfo = RARITY_UPGRADE_COSTS[item.rarity];
        if(!costInfo || rarityEssences[costInfo.essence] < costInfo.cost) {
            addLog(`<strong class="text-red-400">ì¬ë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!</strong>`);
            return;
        }

        setRarityEssences(prev => ({...prev, [costInfo.essence]: prev[costInfo.essence] - costInfo.cost}));

        const nextRarityKey = RARITY_ORDER[currentRarityIndex + 1];
        const updatedItem = {
            ...item,
            rarity: nextRarityKey,
            name: `${RARITIES[nextRarityKey].name} ${EQUIPMENT_TYPES[item.type].name}`,
            stats: calculateItemStats(item.baseLevel, nextRarityKey, item.type),
        };

        updateItemInState(updatedItem);
        setSelectedForgeItem(updatedItem);
        addLog(`[${item.name}] ë“±ê¸‰ ìŠ¹ê¸‰! <strong class="${RARITIES[nextRarityKey].textClass}">[${RARITIES[nextRarityKey].name}]</strong> ë‹¬ì„±!`);
        needsSave.current = true;
    }, [rarityEssences, equipment, addLog]);

    const handleReforgeItem = useCallback((item) => {
        const cost = 1;
        if(chaosOrbs < cost) {
            addLog(`<strong class="text-red-400">ë³€í™”ì˜ ë³´ì£¼ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!</strong>`);
            return;
        }
        setChaosOrbs(prev => prev - cost);
        const updatedItem = {
            ...item,
            stats: calculateItemStats(item.baseLevel, item.rarity, item.type),
        };
        updateItemInState(updatedItem);
        setSelectedForgeItem(updatedItem);
        addLog(`[${item.name}] ëŠ¥ë ¥ì¹˜ ì¬ë ¨ ì™„ë£Œ!`);
        needsSave.current = true;
    }, [chaosOrbs, equipment, addLog]);

    const handleSelectForgeItem = (item) => {
        setSelectedForgeItem(item);
        setActiveTab('forge');
    };

    const handleResetGame = useCallback(() => {
        if (window.confirm('ì •ë§ë¡œ ê²Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì§„í–‰ ìƒí™©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) {
            localStorage.removeItem(SAVED_GAME_KEY);
            window.location.reload();
        }
    }, []);

    const liberationCost = useMemo(() => LIBERATION_COST_BASE * Math.pow(LIBERATION_COST_MULTIPLIER, liberationCount), [liberationCount]);
    const equipmentGachaCost = useMemo(() => EQUIPMENT_GACHA_COST_BASE + playerStats.level * EQUIPMENT_GACHA_COST_LEVEL_MULTIPLIER, [playerStats.level]);
    
    if (!difficulty) {
        return <DifficultySelectionModal onSelect={handleSelectDifficulty} />;
    }

    return (
        <div className="min-h-screen bg-gray-900 text-white flex flex-col items-center p-4 space-y-4">
            <div className="fixed top-4 left-4 z-10">
                <button onClick={handleResetGame} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-lg">
                    ê²Œì„ ì´ˆê¸°í™”
                </button>
            </div>
            <div className="fixed top-4 right-4 z-10">
                <p className="text-gray-500 text-sm">ì œì‘ì: í•œêµ­ì¸ì´ë¼ë©´</p>
            </div>

            {(isJobSelectionOpen || !playerClass) && <JobSelectionModal onSelect={handleJobSelect} onClose={() => setIsJobSelectionOpen(false)}/>}
            <header className="text-center">
                <h1 className="text-5xl font-bold text-green-400 drop-shadow-lg">ìŠ¬ë¼ì„ í—Œí„°</h1>
                <p className="text-gray-400">í´ë¦­í•˜ì—¬ ìŠ¬ë¼ì„ì„ ë¬¼ë¦¬ì¹˜ê³  ìµœê°•ì˜ í—Œí„°ê°€ ë˜ì„¸ìš”!</p>
            </header>
            
            <main className="w-full max-w-7xl flex flex-col md:flex-row gap-4">
                <div className="w-full md:w-1/4 order-1 md:order-1 flex flex-col gap-4">
                   <PlayerStats stats={finalStats} playerClass={playerClass} onNameChange={handlePlayerNameChange} abilityStats={finalAbilityStats} liberationCount={liberationCount} rebirthCount={rebirthCount} onJobChangeClick={() => setIsJobSelectionOpen(true)} />
                   <EquipmentPanel equipment={equipment} />
                </div>
                <div className="w-full md:w-1/2 bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col items-center justify-start order-2 md:order-2 relative overflow-hidden">
                    <MonsterDisplay monster={monsterStats} onClick={handleMonsterClick} damagePopups={damagePopups} />
                    {playerClass && (
                        <div className="w-full mt-8">
                            <ActiveSkillButton 
                                skill={JOBS[playerClass].skill}
                                onClick={handleActiveSkill} 
                                cooldown={activeSkillCooldown} 
                                maxCooldown={finalAbilityStats.activeSkillCooldown}
                            />
                        </div>
                    )}
                </div>
                <RightPanel 
                    activeTab={activeTab}
                    setActiveTab={setActiveTab}
                    selectedForgeItem={selectedForgeItem}
                    onSelectForgeItem={handleSelectForgeItem}
                    upgrades={upgrades}
                    playerCoins={playerStats.coins}
                    abilityStats={finalAbilityStats}
                    equipmentGachaCost={equipmentGachaCost}
                    inventory={inventory}
                    chaosOrbs={chaosOrbs}
                    rarityEssences={rarityEssences}
                    handlers={{
                        onUpgradeClick: handleUpgradeClick,
                        onUpgradeAutoAttack: handleUpgradeAutoAttack,
                        onUpgradeAttackSpeed: handleUpgradeAttackSpeed,
                        onUpgradeCritChance: handleUpgradeCritChance,
                        onUpgradeCritDamage: handleUpgradeCritDamage,
                        onUpgradeGoldGain: handleUpgradeGoldGain,
                        onUpgradeXpGain: handleUpgradeXpGain,
                        onUpgradeSkillDamage: handleUpgradeSkillDamage,
                        onUpgradeHaste: handleUpgradeHaste,
                        onUpgradeLuck: handleUpgradeLuck,
                        onUpgradeBossDamage: handleUpgradeBossDamage,
                        onEquipmentGacha: handleEquipmentGacha,
                        onSelectItem: (item) => setSelectedInventoryItem(item),
                        onForgeItem: handleForgeItem,
                        onUpgradeRarity: handleUpgradeRarity,
                        onReforgeItem: handleReforgeItem,
                    }}
                />
            </main>

            <footer className="w-full max-w-7xl flex flex-col items-center justify-center gap-4">
                 <div className="w-full grid grid-cols-1 md:grid-cols-2 gap-4">
                    <LiberationButton onLiberate={handleLiberation} cost={liberationCost} playerCoins={playerStats.coins} count={liberationCount} />
                    <RebirthButton onRebirth={handleRebirth} level={playerStats.level} count={rebirthCount} />
                 </div>
                 <GameLog log={gameLog}/>
            </footer>

            <NewItemDropModal 
                newItem={newItemDrop}
                currentItem={newItemDrop ? equipment[newItemDrop.type.toLowerCase()] : null}
                onEquip={() => handleEquipItem(newItemDrop)}
                onStore={handleStoreNewItem}
            />

            <InventoryItemDetailModal
                item={selectedInventoryItem}
                currentEquipped={selectedInventoryItem ? equipment[selectedInventoryItem.type.toLowerCase()] : null}
                onClose={() => setSelectedInventoryItem(null)}
                onEquip={handleEquipItem}
                onSalvage={handleSalvageItem}
                onSelectForge={handleSelectForgeItem}
            />
        </div>
    );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
    </script>
  </body>
</html>